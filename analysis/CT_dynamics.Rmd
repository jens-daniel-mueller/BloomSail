---
title: "CT dynamics"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---


```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r packages}
library(tidyverse)
library(patchwork)
library(seacarb)
library(metR)
library(scico)
# library(broom)
# library(lubridate)
# library(tibbletime)
```


# Sensor profile data

Profile data are prepared by:

- Ignoring those made on June 16 (pCO2 sensor not in operation)
- Removing HydroC Flush and Zeroing periods
- Selecting only continous downcast periods
- Gridding profiles to 1m depth intervals
- Discarding profiles with 3 or more observation missing within upper 20m (except shallow coastal station at Ostergarnsholm "P14")

```{r read_prepare_sensor_data, fig.cap="Overview pCO2 profiles at stations (P01-P14) and cruise dates (ID)", fig.asp = 1.3}

df <-
 read_csv(here::here("data/_merged_data_files",
                      "BloomSail_CTD_HydroC_track_RT.csv"),
               col_types = cols(ID = col_character(),
                                pCO2_analog = col_double(),
                                pCO2 = col_double(),
                                Zero = col_character(),
                                Flush = col_character(),
                                mixing = col_character(),
                                Zero_ID = col_integer(),
                                deployment = col_integer(),
                                lon = col_double(),
                                lat = col_double(),
                                pCO2_RT = col_double()))


# Filter relevant rows and columns

df <- df %>% 
  filter(type == "P",
         Flush == "0",
         Zero == "0",
         ID != "180616",
         !(station %in% c("PX1", "PX2"))) %>% 
  select(date_time, ID, type, station, lat, lon, dep, sal, tem, pCO2_raw = pCO2, pCO2 = pCO2_RT_mean, duration)


# Assign meta information

df <- df %>% 
  group_by(ID, station) %>% 
  mutate(duration = as.numeric(date_time - min(date_time))) %>%
  arrange(date_time) %>% 
  ungroup()

meta <- read_csv(here::here("Data/_summarized_data_files",
                          "Tina_V_Sensor_meta.csv"),
                 col_types = cols(ID = col_character()))

meta <- meta %>% 
    filter(ID != "180616",
           !(station %in% c("PX1", "PX2")))

df <- full_join(df, meta)
rm(meta)


# creating descriptive variables
df <- df %>% 
  mutate(phase = "standby",
         phase = if_else(duration >= start & duration < down & !is.na(down) & !is.na(start),   "down", phase),
         phase = if_else(duration >= down  & duration < lift & !is.na(lift) & !is.na(down ),   "low",  phase),
         phase = if_else(duration >= lift  & duration < up   & !is.na(up  ) & !is.na(lift  ),  "mid",  phase),
         phase = if_else(duration >= up    & duration < end  & !is.na(end ) & !is.na(up   ),   "up",   phase))

df <- df %>% 
  select(-c(start, down, lift, up, end, comment, p_type, duration, type))


# select downcasst only
df <- df %>% 
  filter(phase == "down") %>% 
  select(-phase)


# grid observation to 1m depth intervals
df <- df %>% 
  mutate(dep_int = as.numeric(as.character( cut(dep, seq(0,40,1), seq(0.5,39.5,1))))) %>% 
  group_by(ID, station, dep_int) %>%
  summarise_all("mean", na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-dep, dep=dep_int)

# subset complete profiles
profiles_in <- df %>% 
  filter(dep < 20) %>% 
  group_by(ID, station) %>% 
  summarise(nr = n()) %>% 
  mutate(select = if_else(nr > 18 | station == "P14", "in", "out")) %>% 
  select(-nr) %>% 
  ungroup()

df <- full_join(df, profiles_in)
rm(profiles_in)

df %>% 
  filter(dep < 30) %>% 
  arrange(date_time) %>% 
  ggplot(aes(pCO2, dep, col=select))+
  geom_point()+
  geom_path()+
  scale_y_reverse()+
  scale_color_brewer(palette = "Set1", direction = -1)+
  coord_cartesian(xlim = c(0,400))+
  facet_grid(station~ID)

df <- df %>%
  filter(select == "in") %>%
  select(-select)

```


## Station map

```{r map, fig.cap="Location of stations sampled between the east coast of Gotland and Gotland deep."}

map <- read_csv(here::here("data/Maps","Bathymetry_Gotland_east_small.csv"))

df %>% 
  ggplot()+
  geom_raster(data=map, aes(lon, lat, fill=elev))+
  scale_fill_scico(palette = "grayC", na.value = "grey", name="Depth [m]", direction = -1)+
  geom_point(aes(lon, lat, col=station))+
  coord_quickmap(expand = 0, xlim = c(18.7, 19.9), ylim = c(57.25,57.6))+
  theme_bw()+
  theme(legend.position="bottom")

rm(map)

```

## Data coverage

```{r data_coverage, fig.cap="Spatio-temporal data coverage, indicated as station visits over time. ID (color) refers to the starting date of the cruise, except for P14, which was visited twice during each cruise."}

cover <- df %>% 
  group_by(ID, station) %>% 
  summarise(date = mean(date_time)) %>% 
  ungroup()

cover %>% 
  ggplot(aes(date, station, fill=ID))+
  geom_point(shape=21)+
  scale_fill_viridis_d()

rm(cover)

```

# Bottle C~T~ and A~T~

At stations P07 and P10 discrete samples for lab measurments of C~T~ and A~T~ were collected. Please not that - in contrast to the pCO2 profiles - samples were taken on June 16.

```{r read_bottle_CO2}

CO2 <-
  read_csv(here::here("Data/_summarized_data_files", "Tina_V_Bottle_CO2_lab.csv"),
           col_types = cols(ID = col_character()))

CO2 <- CO2 %>% 
  filter(station %in% c("P07", "P10")) %>% 
  select(-pH_Mosley) %>% 
  mutate(CT_AT_ratio = CT/AT)

```

## Vertical profiles

```{r plot_bottle_CO2_profiles}

CO2_long <- CO2 %>% 
  pivot_longer(4:7, names_to = "parameter", values_to = "value")

CO2_long %>% 
  ggplot(aes(value, dep))+
  geom_path(aes(col=ID))+
  geom_point(aes(fill=ID), shape=21)+
  scale_y_reverse()+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  facet_grid(station~parameter, scales = "free_x")


```

## Surface time series

```{r plot_bottle_CO2_surface_timeseries}

CO2_ts <- CO2_long %>% 
  filter(dep<10) %>% 
  group_by(ID, parameter, station) %>% 
  summarise(value = mean(value, na.rm = TRUE)) %>% 
  ungroup()

rm(CO2_long)

CO2_ts %>% 
  ggplot(aes(lubridate::ymd(ID), value, col=station))+
  geom_point()+
  geom_path()+
  scale_fill_viridis_d()+
  scale_color_brewer(palette = "Set1")+
  facet_grid(parameter~., scales = "free_y")+
  labs(x="Transect starting date (from ID)")
  
```

## Mean alkalinity

In order to derive C~T~ from measured pCO~2~ profiles, the mean alkalinity in the upper 20 m and both stations was calculated as:

```{r bottle_AT}

AT_mean <- CO2 %>% 
  filter(dep <= 20) %>% 
  summarise(AT = mean(AT, na.rm = TRUE)) %>%
  pull()

AT_mean

sal_mean <- CO2 %>% 
  filter(dep <= 20) %>% 
  summarise(sal = mean(sal, na.rm = TRUE)) %>%
  pull()

sal_mean

```

# C~T~ profiles

## Calculation from pCO~2~

C~T~ profiles were calculated from sensor pCO~2~ and T profiles, and constant salinity and alkalinity values. Note that the impact of fixed vs. measured salinity has only a negligible impact on C~T~ profiles.

```{r CT_calculation}

df <- df %>% 
  drop_na()

df <- df %>% 
  filter(pCO2 > 0)

df <- df %>% 
  mutate(CT = carb(24, var1=pCO2, var2=1720*1e-6,
                   S=sal_mean, T=tem, P=dep/10, k1k2="m10", kf="dg", ks="d",
                   gas="insitu")[,16]*1e6)

rm(sal_mean, AT_mean)

df %>% 
  write_csv(here::here("Data/_merged_data_files", "BloomSail_CTD_HydroC_CT.csv"))

```

## Mean profiles

Mean vertical profiles are displayed for each cruise day (ID). Note that:

- ID represents the start date of the cruise, not the mean sampling date
- Coastal station P14 was excluded so far from the analysis

```{r plot_CT_profiles, fig.cap="Mean vertical profiles per cruise day across all stations, except P14."}

# df %>% 
#   filter(dep < 20) %>% 
#   arrange(date_time) %>% 
#   ggplot(aes(CT, dep))+
#   geom_point()+
#   geom_path()+
#   scale_y_reverse()+
#   coord_cartesian(ylim = c(30,0))+
#   facet_grid(station~ID)

mean_profiles <- df %>% 
  filter(station != "P14", dep < 25) %>% 
  select(-c(station,lat, lon, pCO2_raw)) %>% 
  group_by(ID, dep) %>% 
  summarise_all(list(mean), na.rm=TRUE) %>% 
  ungroup()

mean_profiles_long <- mean_profiles %>% 
  pivot_longer(4:7, names_to = "parameter", values_to = "value")
  
mean_profiles_long %>% 
  ggplot(aes(value, dep, col=ID))+
  geom_point()+
  geom_path()+
  scale_y_reverse()+
  scale_color_viridis_d()+
  facet_wrap(~parameter, scales = "free_x")
  

```

## Profiles of incremental changes

```{r incremental_changes_profiles}

mean_profiles_long <- mean_profiles_long %>%
    group_by(parameter, dep) %>%
    arrange(date_time) %>%
    mutate(diff_value = value     - lag(value, default = first(value)),
           diff_time  = as.numeric(date_time - lag(date_time)),
           diff_value_daily = diff_value / diff_time,
           cum_value = cumsum(diff_value)) %>% 
  ungroup()

mean_profiles_long %>% 
  arrange(dep) %>% 
  ggplot(aes(diff_value_daily, dep, col=ID))+
  geom_vline(xintercept = 0)+
  geom_point()+
  geom_path()+
  scale_y_reverse()+
  scale_color_viridis_d()+
  facet_wrap(~parameter, scales = "free_x")
  
```

## Profiles of cumulative changes

```{r cumulative_changes_profiles}

mean_profiles_long %>% 
  arrange(dep) %>% 
  ggplot(aes(cum_value, dep, col=ID))+
  geom_vline(xintercept = 0)+
  geom_point()+
  geom_path()+
  scale_y_reverse()+
  scale_color_viridis_d()+
  facet_wrap(~parameter, scales = "free_x")

```

```{r cumulative_directional_changes_profiles}

mean_profiles_long <- mean_profiles_long %>% 
  mutate(sign = if_else(diff_value < 0, "neg", "pos")) %>% 
  group_by(parameter, dep, sign) %>%
  arrange(date_time) %>%
  mutate(cum_value_sign = cumsum(diff_value)) %>% 
  ungroup()

mean_profiles_long %>% 
  arrange(dep) %>% 
  ggplot(aes(cum_value_sign, dep, col=ID))+
  geom_vline(xintercept = 0)+
  geom_point()+
  geom_path()+
  scale_y_reverse()+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  facet_grid(sign~parameter, scales = "free_x")

```


# Timeseries

```{r observed_timeseries}

timeseries <- mean_profiles_long %>% 
  mutate(dep = cut(dep, seq(0,30,5))) %>% 
  group_by(ID, dep, parameter)  %>% 
  summarise_all(list(mean), na.rm=TRUE) 

timeseries %>% 
  ggplot(aes(date_time, value, col=as.factor(dep)))+
  geom_path()+
  geom_point()+
  scale_color_viridis_d(name="Depth [m]")+
  facet_wrap(~parameter, scales = "free_y", ncol=1)

```


```{r integrated_NCP}

NCP <- mean_profiles_long %>% 
  filter(parameter == "CT") %>% 
  group_by(ID, sign) %>% 
  summarise(date_time = mean(date_time),
            dCT = sum(cum_value_sign)/1000) %>% 
  ungroup()

NCP <- NCP %>% 
  group_by(sign) %>% 
  arrange(date_time) %>%
  mutate(dCT_cum = cumsum(dCT)) %>% 
  ungroup()

NCP %>% 
  ggplot(aes(date_time, dCT_cum, col=sign))+
  geom_hline(yintercept = 0)+
  geom_point()+
  geom_path()+
  scale_color_brewer(palette = "Set1")+
  labs(y="integrated, cumulative, directional CT changes [mol/m2]", x="date")


```




```{r plot_hovmoeller, eval=FALSE}

mean_profiles %>% 
  ggplot(aes(date_time, dep, col=CT))+
  geom_point()+
  scale_color_viridis_c(direction = -1)+
  scale_y_reverse()


mean_profiles_long %>%
  filter(parameter == "CT") %>% 
  ggplot(aes(date_time, dep, col=diff))+
  geom_point()+
  scale_color_divergent()+
  scale_y_reverse()

mean_profiles_long %>%
  filter(parameter == "tem") %>% 
  ggplot(aes(date_time, dep, col=diff))+
  geom_point()+
  scale_color_divergent()+
  scale_y_reverse()


```


```{r plot_corrected_discretized_pCO2_profiles, eval=FALSE}

pdf(file=here::here("output/Plots/sensor_data",
    "profiles_check.pdf"), onefile = TRUE, width = 9, height = 5)

for(i_ID in unique(df$ID)){
  for(i_station in unique(df$station)){

    if (nrow(df %>% filter(ID == i_ID, station == i_station)) > 0){
      
      
      # i_ID      <-      unique(df$ID)[1]
      # i_station <- unique(df$station)[1]

      p_pCO2 <- 
        df %>%
        arrange(date_time) %>% 
        filter(ID == i_ID,
               station == i_station) %>%
        ggplot(aes(pCO2, dep))+
        geom_point(aes(pCO2_raw, dep), col="lightgrey")+
        geom_point()+
        geom_path()+
        scale_y_reverse()+
        scale_color_brewer(palette = "Set1")+
        labs(y="Depth [m]", x="pCO2 [µatm]", title = str_c(i_ID," | ",i_station))+
        coord_cartesian(xlim = c(0,200), ylim = c(30,0))+
        theme_bw()+
        theme(legend.position = "left")
      
      p_tem <- 
        df %>%
        arrange(date_time) %>% 
        filter(ID == i_ID,
               station == i_station) %>%
        ggplot(aes(tem, dep))+
        geom_point()+
        geom_path()+
        scale_y_reverse()+
        labs(y="Depth [m]", x="Tem [°C]")+
        coord_cartesian(xlim = c(14,26), ylim = c(30,0))+
        theme_bw()
      
      p_sal <- 
        df %>%
        arrange(date_time) %>% 
        filter(ID == i_ID,
               station == i_station) %>%
        ggplot(aes(sal, dep))+
        geom_point()+
        geom_path()+
        scale_y_reverse()+
        labs(y="Depth [m]", x="Tem [°C]")+
        coord_cartesian(xlim = c(6.5,7.5), ylim = c(30,0))+
        theme_bw()
      
      p_CT <- 
        df %>%
        arrange(date_time) %>% 
        filter(ID == i_ID,
               station == i_station) %>%
        ggplot(aes(CT, dep))+
        geom_point()+
        geom_path()+
        scale_y_reverse()+
        labs(y="Depth [m]", x="CT* [µmol/kg]")+
        coord_cartesian(xlim = c(1400,1700), ylim = c(30,0))+
        theme_bw()
      

      print(
            p_pCO2 + p_tem + p_sal + p_CT
            )
      
      rm(p_pCO2, p_sal, p_tem, p_CT)

      
    }
  }
}

dev.off()

rm(i_ID, i_station)

```





# Open tasks / questions

- Significance of changes in AT for calculated CT changes
- Harmonize selection of profiles for tau optimization and BGC interpretation (how many missing discrete depth intervals are allowed?)
- Vergleich der Stationen
