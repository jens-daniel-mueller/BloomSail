---
title: "CT dynamics"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---


```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r packages}
library(tidyverse)
library(patchwork)
library(seacarb)
library(metR)
library(scico)
# library(broom)
# library(lubridate)
# library(tibbletime)
```


# Sensor data

Profile data are prepared by:

- Ignoring those made on June 16 (pCO2 sensor not in operation)
- Removing HydroC Flush and Zeroing periods
- Selecting only continous downcast periods
- Gridding profiles to 1m depth intervals
- Discarding profiles with 3 or more observation missing within upper 20m (except shallow coastal station at Ostergarnsholm "P14")

## pCO~2~ profile overview

```{r read_prepare_sensor_data, fig.cap="Overview pCO2 profiles at stations (P01-P14) and cruise dates (ID)", fig.asp = 1.5}

df <-
 read_csv(here::here("data/_merged_data_files",
                      "BloomSail_CTD_HydroC_track_RT.csv"),
               col_types = cols(ID = col_character(),
                                pCO2_analog = col_double(),
                                pCO2 = col_double(),
                                Zero = col_character(),
                                Flush = col_character(),
                                mixing = col_character(),
                                Zero_ID = col_integer(),
                                deployment = col_integer(),
                                lon = col_double(),
                                lat = col_double(),
                                pCO2_RT = col_double()))


# Filter relevant rows and columns

df <- df %>% 
  filter(type == "P",
         Flush == "0",
         Zero == "0",
         ID != "180616",
         !(station %in% c("PX1", "PX2"))) %>% 
  select(date_time, ID, type, station, lat, lon, dep, sal, tem, pCO2_raw = pCO2, pCO2 = pCO2_RT_mean, duration)


# Assign meta information

df <- df %>% 
  group_by(ID, station) %>% 
  mutate(duration = as.numeric(date_time - min(date_time))) %>%
  arrange(date_time) %>% 
  ungroup()

meta <- read_csv(here::here("Data/_summarized_data_files",
                          "Tina_V_Sensor_meta.csv"),
                 col_types = cols(ID = col_character()))

meta <- meta %>% 
    filter(ID != "180616",
           !(station %in% c("PX1", "PX2")))

df <- full_join(df, meta)
rm(meta)


# creating descriptive variables
df <- df %>% 
  mutate(phase = "standby",
         phase = if_else(duration >= start & duration < down & !is.na(down) & !is.na(start),   "down", phase),
         phase = if_else(duration >= down  & duration < lift & !is.na(lift) & !is.na(down ),   "low",  phase),
         phase = if_else(duration >= lift  & duration < up   & !is.na(up  ) & !is.na(lift  ),  "mid",  phase),
         phase = if_else(duration >= up    & duration < end  & !is.na(end ) & !is.na(up   ),   "up",   phase))

df <- df %>% 
  select(-c(start, down, lift, up, end, comment, p_type, duration, type))


# select downcasst only
df <- df %>% 
  filter(phase == "down") %>% 
  select(-phase)


# grid observation to 1m depth intervals
df <- df %>% 
  mutate(dep_int = as.numeric(as.character( cut(dep, seq(0,40,1), seq(0.5,39.5,1))))) %>% 
  group_by(ID, station, dep_int) %>%
  summarise_all("mean", na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-dep, dep=dep_int)

# subset complete profiles
profiles_in <- df %>% 
  filter(dep < 20) %>% 
  group_by(ID, station) %>% 
  summarise(nr = n()) %>% 
  mutate(select = if_else(nr > 18 | station == "P14", "in", "out")) %>% 
  select(-nr) %>% 
  ungroup()

df <- full_join(df, profiles_in)
rm(profiles_in)

df %>% 
  filter(dep < 30) %>% 
  arrange(date_time) %>% 
  ggplot(aes(pCO2, dep, col=select))+
  geom_point()+
  geom_path()+
  scale_y_reverse()+
  scale_x_continuous(breaks = c(0,300), labels = c(0,300))+
  scale_color_brewer(palette = "Set1", direction = -1)+
  coord_cartesian(xlim = c(0,400))+
  facet_grid(ID~station)

df <- df %>%
  filter(select == "in") %>%
  select(-select)

```


## Station map

```{r map, fig.cap="Location of stations sampled between the east coast of Gotland and Gotland deep."}

map <- read_csv(here::here("data/Maps","Bathymetry_Gotland_east_small.csv"))

df %>% 
  ggplot()+
  geom_raster(data=map, aes(lon, lat, fill=-elev))+
  scale_fill_scico(palette = "grayC", na.value = "grey", name="Depth [m]")+
  geom_point(aes(lon, lat, col=station))+
  coord_quickmap(expand = 0, xlim = c(18.7, 19.9), ylim = c(57.25,57.6))+
  theme_bw()+
  theme(legend.position="bottom")

rm(map)

```

## Data coverage

```{r data_coverage, fig.cap="Spatio-temporal data coverage, indicated as station visits over time. ID (color) refers to the starting date of the cruise, except for P14, which was visited twice during each cruise."}

cover <- df %>% 
  group_by(ID, station) %>% 
  summarise(date = mean(date_time)) %>% 
  ungroup()

cover %>% 
  ggplot(aes(date, station, fill=ID))+
  geom_point(shape=21)+
  scale_fill_viridis_d()

rm(cover)

```

# Bottle C~T~ and A~T~

At stations P07 and P10 discrete samples for lab measurments of C~T~ and A~T~ were collected. Please note that - in contrast to the pCO~2~ profiles - samples were taken on June 16.

```{r read_bottle_CO2}

CO2 <-
  read_csv(here::here("Data/_summarized_data_files", "Tina_V_Bottle_CO2_lab.csv"),
           col_types = cols(ID = col_character()))

CO2 <- CO2 %>% 
  filter(station %in% c("P07", "P10")) %>% 
  select(-pH_Mosley) %>% 
  mutate(CT_AT_ratio = CT/AT)

```

## Vertical profiles

```{r plot_bottle_CO2_profiles}

CO2_long <- CO2 %>% 
  pivot_longer(4:7, names_to = "parameter", values_to = "value")

CO2_long %>% 
  ggplot(aes(value, dep))+
  geom_path(aes(col=ID))+
  geom_point(aes(fill=ID), shape=21)+
  scale_y_reverse()+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  facet_grid(station~parameter, scales = "free_x")+
  theme(legend.position = "bottom")

```

## Surface time series

```{r plot_bottle_CO2_surface_timeseries, fig.cap="Time series of bottle data. Shown are mean values of samples collected at water depths < 10m (usually at 0 and 5 m).", fig.asp=1.2}

CO2_ts <- CO2_long %>% 
  filter(dep<10) %>% 
  group_by(ID, parameter, station) %>% 
  summarise(value = mean(value, na.rm = TRUE)) %>% 
  ungroup()

rm(CO2_long)

CO2_ts %>% 
  ggplot(aes(lubridate::ymd(ID), value, col=station))+
  geom_point()+
  geom_path()+
  scale_fill_viridis_d()+
  scale_color_brewer(palette = "Set1")+
  facet_grid(parameter~., scales = "free_y")+
  labs(x="Transect starting date (from ID)")


```

```{r plot_bottle_CT_surface_timeseries, fig.cap="CT timeseries, derived by multiplying the CT-AT-ratio with mean AT"}

AT_mean <- CO2_ts %>% 
  filter(parameter == "AT") %>% 
  summarise(AT = mean(value, na.rm = TRUE)) %>%
  pull()

CO2_ts %>% 
  filter(parameter == "CT_AT_ratio") %>% 
  ggplot(aes(lubridate::ymd(ID), value*AT_mean, col=station))+
  geom_point()+
  geom_path()+
  scale_fill_viridis_d()+
  scale_color_brewer(palette = "Set1")+
  labs(x="Transect starting date (from ID)", y="CT-AT-ratio * mean AT")

```


## Mean alkalinity

In order to derive C~T~ from measured pCO~2~ profiles, the mean alkalinity in the upper 20 m and both stations was calculated as:

```{r bottle_AT}

AT_mean <- CO2 %>% 
  filter(dep <= 20) %>% 
  summarise(AT = mean(AT, na.rm = TRUE)) %>%
  pull()

AT_mean

```

Likewise, the mean salinity amounts to:

```{r bottle_sal}

sal_mean <- CO2 %>% 
  filter(dep <= 20) %>% 
  summarise(sal = mean(sal, na.rm = TRUE)) %>%
  pull()

sal_mean

```


# C~T~ profiles

## Calculation from pCO~2~

C~T~ profiles were calculated from sensor pCO~2~ and T profiles, and constant salinity and alkalinity values. Note that the impact of fixed vs. measured salinity has only a negligible impact on C~T~ profiles.

```{r CT_calculation}

df <- df %>% 
  drop_na()

df <- df %>% 
  filter(pCO2 > 0)

df <- df %>% 
  mutate(CT = carb(24, var1=pCO2, var2=1720*1e-6,
                   S=sal_mean, T=tem, P=dep/10, k1k2="m10", kf="dg", ks="d",
                   gas="insitu")[,16]*1e6)

rm(sal_mean, AT_mean)

df %>% 
  write_csv(here::here("Data/_merged_data_files", "BloomSail_CTD_HydroC_CT.csv"))

```

## Mean profiles

Mean vertical profiles are displayed for each cruise day (ID). Note that:

- ID represents the start date of the cruise, not the mean sampling date
- Coastal station P14 was excluded so far from the analysis

```{r plot_CT_profiles, fig.cap="Mean vertical profiles per cruise day across all stations, except P14."}

# df %>% 
#   filter(dep < 20) %>% 
#   arrange(date_time) %>% 
#   ggplot(aes(CT, dep))+
#   geom_point()+
#   geom_path()+
#   scale_y_reverse()+
#   coord_cartesian(ylim = c(30,0))+
#   facet_grid(station~ID)

mean_profiles <- df %>% 
  filter(station != "P14", dep < 25) %>% 
  select(-c(station,lat, lon, pCO2_raw)) %>% 
  group_by(ID, dep) %>% 
  summarise_all(list(mean), na.rm=TRUE) %>% 
  ungroup()

mean_profiles_long <- mean_profiles %>% 
  pivot_longer(4:7, names_to = "parameter", values_to = "value")
  
mean_profiles_long %>% 
  ggplot(aes(value, dep, col=ID))+
  geom_point()+
  geom_path()+
  scale_y_reverse()+
  scale_color_viridis_d()+
  facet_wrap(~parameter, scales = "free_x")
  

```

## Individual profiles

```{r plot_all_discretized_profiles_individual, eval=FALSE}

pdf(file=here::here("output/Plots/CT_dynamics",
    "profiles_individual.pdf"), onefile = TRUE, width = 9, height = 5)

for(i_ID in unique(df$ID)){
  for(i_station in unique(df$station)){

    if (nrow(df %>% filter(ID == i_ID, station == i_station)) > 0){
      
      
      # i_ID      <-      unique(df$ID)[1]
      # i_station <- unique(df$station)[1]

      p_pCO2 <- 
        df %>%
        arrange(date_time) %>% 
        filter(ID == i_ID,
               station == i_station) %>%
        ggplot(aes(pCO2, dep))+
        geom_point(aes(pCO2_raw, dep), col="lightgrey")+
        geom_point()+
        geom_path()+
        scale_y_reverse()+
        scale_color_brewer(palette = "Set1")+
        labs(y="Depth [m]", x="pCO2 [µatm]", title = str_c(i_ID," | ",i_station))+
        coord_cartesian(xlim = c(0,200), ylim = c(30,0))+
        theme_bw()+
        theme(legend.position = "left")
      
      p_tem <- 
        df %>%
        arrange(date_time) %>% 
        filter(ID == i_ID,
               station == i_station) %>%
        ggplot(aes(tem, dep))+
        geom_point()+
        geom_path()+
        scale_y_reverse()+
        labs(y="Depth [m]", x="Tem [°C]")+
        coord_cartesian(xlim = c(14,26), ylim = c(30,0))+
        theme_bw()
      
      p_sal <- 
        df %>%
        arrange(date_time) %>% 
        filter(ID == i_ID,
               station == i_station) %>%
        ggplot(aes(sal, dep))+
        geom_point()+
        geom_path()+
        scale_y_reverse()+
        labs(y="Depth [m]", x="Tem [°C]")+
        coord_cartesian(xlim = c(6.5,7.5), ylim = c(30,0))+
        theme_bw()
      
      p_CT <- 
        df %>%
        arrange(date_time) %>% 
        filter(ID == i_ID,
               station == i_station) %>%
        ggplot(aes(CT, dep))+
        geom_point()+
        geom_path()+
        scale_y_reverse()+
        labs(y="Depth [m]", x="CT* [µmol/kg]")+
        coord_cartesian(xlim = c(1400,1700), ylim = c(30,0))+
        theme_bw()
      

      print(
            p_pCO2 + p_tem + p_sal + p_CT
            )
      
      rm(p_pCO2, p_sal, p_tem, p_CT)

      
    }
  }
}

dev.off()

rm(i_ID, i_station)



```

```{r plot_all_discretized_profiles_by_ID, eval=FALSE}

df_long <- df %>%
  select(-c(lat, lon, pCO2_raw)) %>% 
  filter(dep < 25) %>% 
  pivot_longer(5:8, values_to = "value", names_to = "parameter")


pdf(file=here::here("output/Plots/CT_dynamics",
    "profiles_by_ID.pdf"), onefile = TRUE, width = 9, height = 5)

for(i_ID in unique(df$ID)){

  #i_ID <- unique(df$ID)[1]
  
  sub_df_long <- df_long %>% 
        arrange(date_time) %>% 
        filter(ID == i_ID)
 
  print(
  
  sub_df_long %>% 
    ggplot()+
    geom_path(data = df_long, aes(value, dep, group=interaction(station, ID)), col="grey")+
    geom_path(aes(value, dep, col=station))+
    scale_y_reverse()+
    labs(y="Depth [m]", title = str_c("ID: ", i_ID))+
    theme_bw()+
    facet_wrap(~parameter, scales = "free_x")
   
  )  
  rm(sub_df_long)
}

dev.off()

rm(i_ID, df_long)

```

C~T~, pCO~2~, S, and T profiles were plotted individually 
[pdf here](https://github.com/jens-daniel-mueller/BloomSail/tree/master/output/Plots/CT_dynamics/profiles_individual.pdf){target="_blank"} 
and grouped by ID 
[pdf here](https://github.com/jens-daniel-mueller/BloomSail/tree/master/output/Plots/CT_dynamics/profiles_by_ID.pdf){target="_blank"}. 


## Profiles of incremental changes

Changes of seawater parameters at each depth are calculated from one cruise day to next and divided by the number of days inbetween.

```{r incremental_changes_profiles}

mean_profiles_long <- mean_profiles_long %>%
    group_by(parameter, dep) %>%
    arrange(date_time) %>%
    mutate(diff_value = value     - lag(value, default = first(value)),
           diff_time  = as.numeric(date_time - lag(date_time)),
           diff_value_daily = diff_value / diff_time,
           cum_value = cumsum(diff_value)) %>% 
  ungroup()

mean_profiles_long %>% 
  arrange(dep) %>% 
  ggplot(aes(diff_value_daily, dep, col=ID))+
  geom_vline(xintercept = 0)+
  geom_point()+
  geom_path()+
  scale_y_reverse()+
  scale_color_viridis_d()+
  facet_wrap(~parameter, scales = "free_x")+
  labs(x="Change of value inbetween cruises per day")
  
```

## Profiles of cumulative changes

Cumulative changes of seawater parameters at each depth relative to the first cruise day on July 5.

```{r cumulative_changes_profiles}

mean_profiles_long %>% 
  arrange(dep) %>% 
  ggplot(aes(cum_value, dep, col=ID))+
  geom_vline(xintercept = 0)+
  geom_point()+
  geom_path()+
  scale_y_reverse()+
  scale_color_viridis_d()+
  facet_wrap(~parameter, scales = "free_x")+
  labs(x="Cumulative change of value")

```

Cumulative positive vs negative changes of seawater parameters at each depth relative to the first cruise day on July 5.

```{r cumulative_directional_changes_profiles}

mean_profiles_long <- mean_profiles_long %>% 
  mutate(sign = if_else(diff_value < 0, "neg", "pos")) %>% 
  group_by(parameter, dep, sign) %>%
  arrange(date_time) %>%
  mutate(cum_value_sign = cumsum(diff_value)) %>% 
  ungroup()

mean_profiles_long %>% 
  arrange(dep) %>% 
  ggplot(aes(cum_value_sign, dep, col=ID))+
  geom_vline(xintercept = 0)+
  geom_point()+
  geom_path()+
  scale_y_reverse()+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  facet_wrap(~interaction(sign, parameter), scales = "free_x", ncol=4)+
  labs(x="Cumulative directional change of value")

```


# Timeseries

## Observed

```{r observed_timeseries, fig.asp=1.3}

timeseries <- mean_profiles_long %>% 
  mutate(dep = cut(dep, seq(0,30,5))) %>% 
  group_by(ID, dep, parameter)  %>% 
  summarise_all(list(mean), na.rm=TRUE) 

timeseries %>% 
  ggplot(aes(date_time, value, col=as.factor(dep)))+
  geom_path()+
  geom_point()+
  scale_color_viridis_d(name="Depth [m]")+
  facet_wrap(~parameter, scales = "free_y", ncol=1)

```

## Cumulative

```{r integrated_NCP}

NCP <- mean_profiles_long %>% 
  filter(parameter == "CT") %>% 
  mutate(dep = cut(dep, seq(0,30,5))) %>% 
  group_by(ID, dep, sign) %>% 
  summarise(date_time = mean(date_time),
            dCT = sum(cum_value_sign)/1000) %>% 
  ungroup()

NCP <- NCP %>% 
  group_by(sign, dep) %>% 
  arrange(date_time) %>%
  mutate(dCT_cum = cumsum(dCT)) %>% 
  ungroup()


NCP_grid <- expand_grid(
  unique(NCP$ID),
  unique(NCP$dep),
  unique(NCP$sign)
)

NCP_grid <- NCP_grid %>% 
  set_names(c("ID", "dep", "sign"))

NCP <- full_join(NCP, NCP_grid)

NCP <- NCP %>% 
  arrange(sign, dep, ID) %>% 
  group_by(sign, dep) %>% 
  fill(dCT_cum) %>% 
  ungroup() %>% 
  mutate(dCT_cum = if_else(is.na(dCT_cum), 0, dCT_cum))

NCP %>% 
  ggplot(aes(lubridate::ymd(ID), dCT_cum, fill=dep))+
  geom_hline(yintercept = 0)+
  geom_area(alpha = 0.8, col="white")+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  scale_y_continuous(breaks = seq(-100, 100, 1))+
  facet_grid(rev(sign)~., scales = "free_y", space = "free_y")+
  theme(strip.background = element_blank(),
        strip.text = element_blank())+
  labs(y="integrated, cumulative, directional CT changes [mol/m2]", x="date")


```


```{r plot_hovmoeller, eval=FALSE}

mean_profiles %>% 
  ggplot(aes(date_time, dep, col=CT))+
  geom_point()+
  scale_color_viridis_c(direction = -1)+
  scale_y_reverse()


mean_profiles_long %>%
  filter(parameter == "CT") %>% 
  ggplot(aes(date_time, dep, col=diff))+
  geom_point()+
  scale_color_divergent()+
  scale_y_reverse()

mean_profiles_long %>%
  filter(parameter == "tem") %>% 
  ggplot(aes(date_time, dep, col=diff))+
  geom_point()+
  scale_color_divergent()+
  scale_y_reverse()


```


# Open tasks / questions

- Significance of changes in AT for calculated CT changes
- Harmonize selection of profiles for tau optimization and BGC interpretation (how many missing discrete depth intervals are allowed?)
- Compare stations
