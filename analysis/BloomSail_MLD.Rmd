---
title: "MLD"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---


```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r packages}
library(tidyverse)
library(seacarb)
library(oce)
library(marelac)
library(patchwork)
```

# Sensor data

1m gridded, downcast profiles were used.

```{r read_Tina-V_Sensor_data}

df <-
  read_csv(here::here("Data/_merged_data_files", "ts_profiles_CT.csv"))

```


# Mixed layer depth

## Calculation

Seawater density Rho was determined from S, T, and p according to TEOS-10.

```{r calulcate_seawater_density}

df <- df %>% 
  mutate(rho = swSigma(salinity = sal, temperature = tem, pressure = dep/10))

 # seacarb = rho(S = sal, T = tem, P = pres),
 # marelac = sw_dens(S = sal, t = tem, p = pres + 1, method = "Gibbs")

```

Mixed layer depth (MLD) was determined based on the difference between density at the surface and at depth, for a range of density criteria

```{r calculate_MLD}
# density criterion

df <- expand_grid(df, rho_lim = c(0.1,0.2,0.5))

df <- df %>% 
  group_by(ID, date_time_ID, station, rho_lim) %>% 
  arrange(dep) %>% 
  mutate(d_rho = rho - first(rho)) %>% 
  mutate(layer = if_else(d_rho > rho_lim, "deep", "surface")) %>% 
  ungroup()
  
MLD <- df  %>% 
  group_by(ID, date_time_ID, station, rho_lim) %>% 
  filter(d_rho > rho_lim) %>% 
  summarise(MLD = min(dep)) %>% 
  ungroup()

df <- full_join(df, MLD)

MLD_sum <- MLD %>% 
  select(-station) %>% 
  group_by(ID, date_time_ID, rho_lim)%>%
  summarise_all(list(~mean(.),~sd(.),~min(.), ~max(.))) %>% 
  ungroup()

```

## Density profiles

```{r plot_density_profiles, fig.cap="Overview density profiles at stations (P01-P14) and cruise dates (ID). Horizontal lines indicate determined MLD", fig.asp=1.2}

df %>% 
  filter(dep < 30) %>% 
  arrange(dep) %>% 
  ggplot(aes(rho, dep))+
  geom_hline(aes(yintercept = MLD, col=as.factor(rho_lim)))+
  geom_path()+
  scale_y_reverse()+
  scale_color_discrete(name="Rho lim")+
  facet_grid(ID~station)

```

Rho, S, and T profiles were plotted individually 
[pdf here](https://github.com/jens-daniel-mueller/BloomSail/tree/master/output/Plots/MLD/profiles_MLD_individual.pdf){target="_blank"}.

```{r plot_profiles_MLD_individual, eval=FALSE}

df_long <- df %>% 
  pivot_longer(cols = c("sal", "tem", "rho"), names_to = "parameter", values_to = "value")

pdf(file=here::here("output/Plots/MLD",
    "profiles_MLD_individual.pdf"), onefile = TRUE, width = 9, height = 5)

for(i_ID in unique(df_long$ID)){
  for(i_station in unique(df_long$station)){
 
      
      # i_ID      <-      unique(df_long$ID)[1]
      # i_station <- unique(df_long$station)[1]

      if (nrow(df_long %>% filter(ID == i_ID, station == i_station)) > 0){
      
      print(
        df_long %>%
          arrange(date_time) %>% 
          filter(ID == i_ID,
                 station == i_station) %>%
          ggplot(aes(value,dep))+
          geom_hline(aes(yintercept = MLD, col=as.factor(rho_lim)))+
          geom_path()+
          scale_y_reverse(limits = c(30,0))+
          scale_color_discrete(name="Rho lim")+
          labs(y="Depth [m]", title = str_c(i_ID," | ",i_station))+
          facet_wrap(~parameter, scales = "free_x")+
          theme_bw()
      )
    }
  }
}

dev.off()

rm(i_ID, i_station)



```


# NCP penetration depth

The effective NCP penetration depth, z~eff~, was calculated as the ratio of the observed inremental change of the depth integrated NCP, divided by the change in surface C~T~. 

## C~T~ and NCP changes

```{r NCP_penetration_depth_calculation, eval=FALSE}

CT_ts <-
  read_csv(here::here("Data/_merged_data_files", "BloomSail_CTD_HydroC_CT_cumulative_timeseries.csv"))

CT_profiles <-
  read_csv(here::here("Data/_merged_data_files", "ts_profiles_ID_long_cum.csv"))

CT_conc_surf <-
  CT_profiles %>% 
  filter(dep == 3.5,
         parameter == "CT",
         sign == "neg") %>% 
  group_by(date_time_ID) %>% 
  summarise(dCT = mean(diff_value)) %>% 
  ungroup()

NCP_integ <- CT_ts %>% 
  filter(sign == "neg") %>% 
  group_by(ID, date_time_ID) %>% 
  summarise(dNCPi = sum(dCT)) %>% 
  ungroup()

CT <- full_join(CT_conc_surf, NCP_integ)

rm(CT_conc_surf, NCP_integ, CT_ts, CT_profiles)

CT <- CT %>% 
  mutate(zeff = (dNCPi/dCT)*1e3)

CT_long <- CT %>% 
  pivot_longer(c(dCT, dNCPi), names_to = "parameter", values_to = "values")

CT_long %>% 
  ggplot(aes(date_time_ID, values))+
  geom_path()+
  geom_point()+
  facet_grid(parameter~., scales = "free_y")

```

## Time series MLD and zeff

```{r plot_NCP_penetration_depth_and_MLD, eval=FALSE}

df <- full_join(MLD_sum, CT)

date_grid <- df %>% 
  select(ID, date_time_ID) %>% 
  unique() %>% 
  arrange(date_time_ID) %>% 
  mutate(diff_date = difftime(date_time_ID, lag(date_time_ID))/2,
         mean_date = date_time_ID - diff_date) %>% 
  select(ID, mean_date)

df <- full_join(df, date_grid)
rm(date_grid)

df %>% 
  ggplot()+
  geom_hline(yintercept = 0)+
  geom_ribbon(aes(date_time_ID, ymin = min, ymax = max, fill="MLD"), alpha = 0.2)+
  geom_path(aes(date_time_ID, mean, col="MLD"))+
  geom_errorbar(aes(date_time_ID, ymin = mean-sd, ymax = mean+sd, col="MLD"))+
  geom_point(aes(date_time_ID, mean, col="MLD"))+
  geom_point(aes(mean_date, zeff, col="zeff"))+
  geom_line(aes(mean_date, zeff, col="zeff"))+
  labs(x="Mean transect date", y="Depth [m]")+
  scale_y_reverse()+
  scale_color_brewer(palette = "Set1", direction = -1, name="")+
  scale_fill_brewer(palette = "Set1", direction = -1, guide=FALSE)+
  facet_grid(rho_lim~., labeller = label_both)


```

# Reconstruct NCP

## Calculation

Integrated C~T~ depletion was calculated as the product of observed incremental C~T~ changes in surface waters and the respective mixed layer depth. 

```{r NCP_calculation, eval=FALSE}

df <- df %>% 
  mutate(rho_lim = as.factor(rho_lim))
  
df_cum <- df %>% 
  #filter(!is.na(dCT)) %>% 
  group_by(rho_lim) %>% 
  arrange(date_time_ID) %>% 
  mutate(NCP_recalc = dCT * mean / 1000,
         NCP_cum = cumsum(replace_na(NCP_recalc, 0))) %>% 
  ungroup()
  

```


## Incremental and cumulative timeseries

Total incremental and cumulative C~T~ changes inbetween cruise dates were calculated.


```{r plot_integrated_NCP_timeseries, fig.asp=1.5, eval=FALSE}

p_iNCP <- df_cum %>% 
  ggplot(aes(mean_date, NCP_recalc, fill= rho_lim))+
  geom_hline(yintercept = 0)+
  geom_col(col="black", position = "dodge")+
  scale_y_continuous(breaks = seq(-100, 100, 0.2))+
  scale_fill_viridis_d()+
  labs(y="integrated, directional CT changes [mol/m2]", x="date")

p_iNCPcum <- df_cum %>% 
  ggplot(aes(date_time_ID,  NCP_cum, 
             fill=rho_lim))+
  geom_area(position = "identity", col="black")+
  geom_hline(yintercept = 0)+
  scale_fill_viridis_d()+
  scale_y_continuous(breaks = seq(-100, 100, 0.2))+
  facet_grid(rho_lim~., scales = "free_y", space = "free_y")+
  theme(strip.background = element_blank(),
        strip.text = element_blank())+
  labs(y="integrated, cumulative, directional CT changes [mol/m2]", x="date")


(p_iNCP / p_iNCPcum)+
  plot_layout(guides = 'collect', heights = c(1, 2))

rm(p_iNCP, p_iNCPcum)
```
