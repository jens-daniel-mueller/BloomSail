---
title: "Finnmaid and GETM"
author: "Jens Daniel Müller und Lara Sophie Burchardt"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---


```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r packages}
library(tidyverse)
library(ncdf4)
library(vroom)
library(lubridate)
library(here)
library(seacarb)
library(oce)
library(patchwork)
library(zoo)
library(metR)
```


```{r ggplot_theme, include = FALSE}
theme_set(theme_bw())
```


```{r subsetting_criteria}

# route
select_route <- "E"

# latitude limits
low_lat <- 57.3
high_lat <- 57.5

#depth range to subset GETM 3d files
d1_shallow <- 0
d1_deep <- 25

# date limits
start_date <- "2018-06-20"
end_date <- "2018-08-25"

fixed_values <- 
  read_csv(here::here("Data/_summarized_data_files", "tb_fix.csv"))


```

# Approach

In order to test how (and how well) the depth-integrated C~T~ estimates can be reproduced if only surface CO~2~ data from VOS Finnamaid and hydrographical GETM model date were available, two reconstruction approaches were tested:

1. MLD: Integration of surface observation across the MLD, assuming homogenious vertical patterns
2. Temperature: Vertical reconstruction of incremental CT changes based on profiles of incremental changes in temperature

# GETM

The following information refer to regional mean values modeled along the Finnmaid track east and within the BloomSail field work area (57.3 - 57.5 N). 

## STD Profiles 

Mean daily salinity and temperature profiles were extracted from 3d GETM data (vertically resolved transects).

```{r read_gt_3d_sal_tem, eval=FALSE}

nc <- nc_open(here::here("data/GETM", "Finnmaid.E.3d.2018.nc"))
#print(nc$var)

lat <- ncvar_get(nc, "latc")

time_units <- nc$dim$time$units %>%     #we read the time unit from the netcdf file to calibrate the time 
    substr(start = 15, stop = 33) %>%   #calculation, we take the relevant information from the string
    ymd_hms()                           # and transform it to the right format
t <- time_units + ncvar_get(nc, "time") # read time vector
rm(time_units)

d <- ncvar_get(nc, "zax") # read depths vector

for (var_3d in c("salt", "temp", "SurfaceAge")) {
  
array <- ncvar_get(nc, var_3d) # store the data in a 3-dimensional array
#dim(array) # should be 3d with dimensions: 544 coordinates, 51 depths, and number of days of month

fillvalue <- ncatt_get(nc, var_3d, "_FillValue")

# Working with the data
array[array == fillvalue$value] <- NA

    for (i in seq(1,length(t),1)){
      
      # i <- 3
      array_slice <- array[, , i] # slices data from one day
      
      array_slice_df <- as.data.frame(t(array_slice))
      array_slice_df <- as_tibble(array_slice_df)
      
      gt_3d_part <- array_slice_df %>%
        set_names(as.character(lat)) %>%
        mutate(dep = -d) %>%
        gather("lat", "value", 1:length(lat)) %>%
        mutate(lat = as.numeric(lat)) %>%
        filter(lat > low_lat, lat < high_lat,
               dep >= d1_shallow, dep <= d1_deep) %>%
        #summarise_all("value") %>%
        mutate(var = var_3d,
               date_time=t[i]) %>% 
        dplyr::select(date_time, dep, value, var) #%>% 
        #filter(date_time >= start_date, date_time <= end_date)

      
      if (exists("gt_3d")) {
        gt_3d <- bind_rows(gt_3d, gt_3d_part)
        } else {gt_3d <- gt_3d_part}
      
  rm(array_slice, array_slice_df, gt_3d_part)
      
    }
rm(array, fillvalue)

}

nc_close(nc)
rm(nc)

gt_3d <- gt_3d %>% 
  filter(date_time >= start_date & date_time <= end_date) %>% 
  group_by(dep,var,date_time ) %>% 
  summarise_all(list(value=~mean(.,na.rm=TRUE))) %>%
  ungroup()

gt_3d %>% 
  vroom_write((here::here("data/_summarized_data_files", file = "gt_3d_long.csv")))


rm(gt_3d, d1_deep, d1_shallow, i, lat, d, t, var_3d)

```

Seawater density was calculated according to TEOS-10.

```{r calculate_density_gt_3d}

gt_3d_long <- 
  read_tsv((here::here("data/_summarized_data_files", file = "gt_3d_long.csv")))

gt_3d <- gt_3d_long %>% 
  pivot_wider(values_from = value, names_from = var) %>% 
  mutate(rho = swSigma(salinity = salt, temperature = temp, pressure = dep/10))

```

```{r plot_gt_profiles_salt_temp_rho}

gt_3d_long <- gt_3d %>% 
  pivot_longer(c(salt, SurfaceAge, temp, rho), values_to = "value", names_to = "var")

gt_3d_long %>% 
  ggplot(aes(value, dep,
             col=date_time,
             group=date_time))+
  geom_path()+
  scale_y_reverse(expand = c(0,0))+
  scale_color_viridis_c(name="Date", trans = "time")+
  facet_wrap(~var, scales = "free_x", ncol = 2)

```


## Mixed layer depth

Mean mixed/mixing layer depth estimates based on sewater density and windspeed were extracted from 3h GETM surface data.

```{r read_gt_2d_mld_wind, eval=FALSE}

nc_2d <- nc_open(here("data/GETM", "Finnmaid.E.2d.2018.nc"))
#print(nc_2d)

lat <- ncvar_get(nc_2d, "latc")

time_units <- nc_2d$dim$time$units %>%     #we read the time unit from the netcdf file to calibrate the time 
    substr(start = 15, stop = 33) %>%   #calculation, we take the relevant information from the string
    ymd_hms()                           # and transform it to the right format
t <- time_units + ncvar_get(nc_2d, "time") # read time vector
rm(time_units)

for (var in names(nc_2d$var)[c(3,4,6:12)]) {
  
#var <- "mld_rho"

array <- ncvar_get(nc_2d, var) # store the data in a 3-dimensional array
fillvalue <- ncatt_get(nc_2d, var, "_FillValue")
array[array == fillvalue$value] <- NA

array <- as.data.frame(t(array), xy=TRUE)
array <- as_tibble(array)
      
  gt_2d_part <- array %>%
  set_names(as.character(lat)) %>%
  mutate(date_time = t) %>%
  filter(date_time >= start_date & date_time <= end_date) %>% 
  gather("lat", "value", 1:length(lat)) %>%
  mutate(lat = as.numeric(lat)) %>%
  filter(lat > low_lat, lat<high_lat) %>%
  select(-lat) %>% 
  group_by(date_time) %>% 
  summarise_all(list(value=~mean(.,na.rm=TRUE))) %>%
  ungroup() %>% 
  mutate(var = var)
     
  if (exists("gt_2d")) {
    gt_2d <- bind_rows(gt_2d, gt_2d_part)
    } else {gt_2d <- gt_2d_part} 

rm(array, fillvalue, gt_2d_part)

}

nc_close(nc_2d)
rm(nc_2d)

gt_2d <- gt_2d %>% 
  mutate(value = round(value, 3)) %>% 
  pivot_wider(values_from = value, names_from = var) %>% 
  mutate(U_10 = round(sqrt(u10^2 + v10^2), 3)) %>% 
  select(-c(u10, v10))


gt_2d %>% 
  vroom_write((here::here("data/_summarized_data_files", file = "gt_2d.csv")))

rm(t, var, gt_2d, lat)

```

### Hovmoeller Plots

```{r gt_hovmoeller_salt_temp_rho_age, fig.asp=1.1}

gt_2d <- 
  read_tsv((here::here("data/_summarized_data_files", file = "gt_2d.csv")))

gt_2d_daily <- gt_2d %>% 
  mutate(day = yday(date_time)) %>% 
  group_by(day) %>% 
  summarise_all(list(~mean(.,na.rm=TRUE))) %>%
  ungroup() %>% 
  select(-day)

p_sal <- gt_3d %>% 
  ggplot()+
  geom_raster(aes(date_time, dep, fill=salt))+
  geom_vline(data=fixed_values, aes(xintercept = start))+
  geom_vline(data=fixed_values, aes(xintercept = end))+
  scale_fill_viridis_c(name="Salinity ", direction = -1)+
  scale_y_reverse()+
  coord_cartesian(expand = 0)+
  labs(y="Depth [m]")+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank())+
  geom_line(data= gt_2d_daily,
            aes(x = date_time, y = mld_rho), color = "white")


p_tem <- gt_3d %>% 
  ggplot()+
  geom_raster(aes(date_time, dep, fill=temp))+
  geom_vline(data=fixed_values, aes(xintercept = start))+
  geom_vline(data=fixed_values, aes(xintercept = end))+
  scale_fill_viridis_c(name="Temperature (°C)", option = "B")+
  scale_y_reverse()+
  coord_cartesian(expand = 0)+
  labs(y="Depth [m]", x="")+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank())+
  geom_line(data= gt_2d_daily,
            aes(x = date_time, y = mld_rho), color = "white")

p_rho <- gt_3d %>% 
  ggplot()+
  geom_raster(aes(date_time, dep, fill=rho))+
  geom_vline(data=fixed_values, aes(xintercept = start))+
  geom_vline(data=fixed_values, aes(xintercept = end))+
  scale_fill_viridis_c(name="d Rho (kg/m^3)", direction = -1)+
  scale_y_reverse()+
  coord_cartesian(expand = 0)+
  labs(y="Depth [m]", x="")+
  theme(axis.title.x = element_blank())+
  geom_line(data= gt_2d_daily,
            aes(x = date_time, y = mld_rho), color = "white")

p_age <- gt_3d %>% 
  ggplot()+
  geom_raster(aes(date_time, dep, fill=SurfaceAge))+
  geom_vline(data=fixed_values, aes(xintercept = start))+
  geom_vline(data=fixed_values, aes(xintercept = end))+
  scale_fill_viridis_c(name="SurfaceAge (d)", direction = -1, trans = "sqrt")+
  scale_y_reverse()+
  coord_cartesian(expand = 0)+
  labs(y="Depth [m]", x="")+
  theme(axis.title.x = element_blank())+
  geom_line(data= gt_2d_daily,
            aes(x = date_time, y = mld_rho), color = "white")

p_sal / p_tem / p_rho / p_age

rm(p_sal, p_tem, p_rho)

```

### Test calculation

Mean mixed layer depth estimates were also calculated for a range of density threshold criteria, Rho lim, from sewater density based on daily mean GETM STD profiles.

```{r calculate_MLD_gt_3d}

gt_3d_MLD <- expand_grid(gt_3d, rho_lim = seq(0.1,0.5,0.1))

gt_3d_MLD <- gt_3d_MLD %>% 
  arrange(dep) %>% 
  group_by(date_time, rho_lim) %>% 
  mutate(d_rho = rho - first(rho)) %>% 
  filter(d_rho > rho_lim) %>% 
  summarise(MLD = min(dep)) %>% 
  ungroup() %>% 
  mutate(rho_lim = as.factor(rho_lim))

```

### Time series

```{r gt_MLD_time_series}

gt_2d_daily_long <- gt_2d_daily %>% 
  pivot_longer(4:8, names_to = "var", values_to = "value")

p_MLD_gt <- gt_2d_daily_long %>% 
  ggplot()+
  geom_rect(data = fixed_values, aes(xmin=start, xmax=end, ymin=-Inf, ymax=Inf), alpha=0.2)+
  geom_hline(yintercept = 0)+
  geom_line(aes(date_time, value, col=var))+
  scale_y_reverse(limits = c(25,0))+
  scale_color_brewer(palette = "Set1", name="GETM variable")+
  labs(x="", y="MLD (m)")+
  theme(axis.title.x = element_blank())

p_MLD_recalc <- gt_3d_MLD %>% 
  ggplot()+
  geom_rect(data = fixed_values, aes(xmin=start, xmax=end, ymin=-Inf, ymax=Inf), alpha=0.2)+
  geom_hline(yintercept = 0)+
  geom_line(aes(date_time, MLD, col=rho_lim))+
  scale_y_reverse(limits = c(25,0))+
  scale_color_viridis_d(name="Rho lim")+
  labs(x="", y="MLD (m)")

p_MLD_gt / p_MLD_recalc

rm(p_MLD_gt, p_MLD_recalc)

```


## Windspeed

```{r plot_gt_winspeed}

gt_2d %>% 
  ggplot()+
  geom_rect(data = fixed_values, aes(xmin=start, xmax=end, ymin=-Inf, ymax=Inf), alpha=0.2)+
  geom_line(aes(x= date_time, y = U_10, col="3-hourly"))+
  geom_line(data = gt_2d_daily,
            aes(x= date_time, y = U_10, col="Daily mean"))+
  labs(y="U (m/s)", x = "Date")+
  scale_color_brewer(palette = "Set1", name="", direction = -1)+
  theme_bw()

```



# Finnmaid

## Read data

Finnmaid data, including reconstructed data during LICOS operation failure.

```{r read_Finnmaid}

fm <-
 read_csv(here::here("Data/_summarized_data_files",
                      "Finnmaid.csv"))

fm <- fm %>% 
  filter(Area == "BS",
         date > start_date,
         date < end_date) %>% 
  select(-c(Lon, Lat, patm, Teq, xCO2, route, Area)) %>% 
  mutate(ID = as.factor(ID)) %>% 
  rename(tem=Tem,
         sal=Sal)

```

## C~T~ calculation

Calculate based on fixed A~T~ and salinity mean values. 

```{r CT_calculation}

fm <- fm %>% 
  mutate(CT = carb(24,
                   var1=pCO2,
                   var2=fixed_values$AT*1e-6,
                   S=fixed_values$sal,
                   T=tem,
                   k1k2="m10", kf="dg", ks="d", gas="insitu")[,16]*1e6)

```

## Timeseries

Calculate regional mean and sd values for each crossing of the area.

```{r timeseries_of_regional_averages}

fm_ID <- fm %>% 
  pivot_longer(c(pCO2, sal, tem, cO2, CT), values_to = "value", names_to = "var") %>% 
  group_by(ID) %>% 
  mutate(date = mean(date)) %>%
  ungroup() %>% 
  group_by(ID, date, sensor, var) %>% 
  summarise_all(list(~mean(.), ~sd(.), ~min(.), ~max(.)), na.rm=TRUE) %>%
  ungroup() %>% 
  rename(value=mean)

# fm_ID_mean <- fm %>% 
#   arrange(date) %>% 
#   group_by(ID, sensor) %>% 
#   summarise_all(list(~mean(.)), na.rm=TRUE) %>%
#   ungroup() %>% 
#   pivot_longer(4:8, values_to = "value", names_to = "var")
# 
# fm_ID_sd <- fm %>% 
#   arrange(date) %>% 
#   group_by(ID, sensor) %>% 
#   summarise_all(list(~sd(.)), na.rm=TRUE) %>%
#   ungroup() %>% 
#   pivot_longer(4:8, values_to = "sd", names_to = "var") %>% 
#   select(-date)
# 
# fm_ID <- inner_join(fm_ID_mean, fm_ID_sd)
# 
# rm(fm_ID_mean, fm_ID_sd)

```

Read BloomSail profile data from 1-5m to fill observational gap of Finnmaid date in second half of June.

```{r read_BloomSail_sensor_data}

ts_profiles_ID_long <-
  read_csv(here::here("Data/_merged_data_files", "ts_profiles_ID_long_cum.csv"))

ts_profiles_ID_long_surface <- ts_profiles_ID_long %>% 
  filter(dep > 1, dep < 5) %>% 
  mutate(ID = as.factor(ID)) %>% 
  select(-c(sign, value_cum_sign)) %>% 
  group_by(ID, date_time_ID, var) %>% 
  summarise_all(list(~mean(.)), na.rm = TRUE) %>% 
  ungroup()

```

```{r fm_ts_time_series, fig.asp=1.5}

fm_ID %>% 
  ggplot()+
  geom_rect(data = fixed_values, aes(xmin=start, xmax=end, ymin=-Inf, ymax=Inf), alpha=0.2)+
  geom_path(aes(x=date, y=value))+
  #geom_ribbon(aes(x=date, y=value, ymax=max, ymin=min, fill="Finnmaid"), alpha=0.3)+
  geom_ribbon(aes(x=date, y=value, ymax=value+sd, ymin=value-sd, fill="Finnmaid"), alpha=0.3)+
  geom_ribbon(data = ts_profiles_ID_long_surface,
             aes(x=date_time_ID, ymin=value-sd, ymax=value+sd, fill="BloomSail"), alpha=0.3)+
  geom_point(aes(x=date, y=value, col=sensor))+
  geom_point(data = ts_profiles_ID_long_surface,
             aes(x=date_time_ID, y=value, col="BloomSail"))+
  geom_line(data = ts_profiles_ID_long_surface,
             aes(x=date_time_ID, y=value, col="BloomSail"))+
  facet_grid(var~., scales = "free_y")+
  scale_color_brewer(palette = "Set1")+
  scale_fill_brewer(palette = "Set1", name="+/- SD")

```

## Missing observations

The observational gaps in the Finnmaid SST and C~T~ time series were filled with two BloomSail observations. The time series was restricted to the period where BloomSail observations are available.

```{r fm_fill_gap_ts}

ts_gap <- ts_profiles_ID_long_surface %>% 
  filter(ID %in% c("180718", "180723"),
         var %in% c("tem", "CT")) %>% 
  select(date = date_time_ID, ID, var, value = value) %>% 
  mutate(sensor = "BloomSail")

fm_ts_ID <- full_join(fm_ID, ts_gap) %>% 
  arrange(date) %>% 
  select(-sd) %>% 
  filter(var %in% c("tem", "CT")) %>% 
  mutate(period = "BloomSail",
         period = if_else(date < fixed_values$start, "pre-BloomSail", period),
         period = if_else(date > fixed_values$end, "post-BloomSail", period))

fm_ts_ID %>% 
  ggplot()+
  geom_rect(data = fixed_values,
            aes(xmin=start, xmax=end, ymin=-Inf, ymax=Inf), alpha=0.2)+
  geom_path(aes(date, value, col=period))+
  geom_point(aes(date, value, col=period))+
  facet_grid(var~., scales = "free_y")+
  scale_color_brewer(palette = "Set1")

fm_ts_ID <- fm_ts_ID %>% 
  filter(period == "BloomSail") %>% 
  select(-period)

rm(fm_ID, fm, ts_gap, ts_profiles_ID_long_surface)

```


# iC~T~

## MLD approach

Use dCT from Finnmaid and MLD from GETM and calculate iC~T~ as their product.

```{r iCT_MLD}

iCT_MLD <- fm_ts_ID %>%
  select(date, var, value) %>% 
  pivot_wider(values_from = value, names_from = var) %>% 
  set_names(c("date_time", "SST", "CT"))

iCT_MLD <- full_join(iCT_MLD,
                     gt_2d_daily %>% select(-c(SSS, SST, U_10)))

iCT_MLD <- iCT_MLD %>% 
  pivot_longer(cols = 4:8, values_to = "MLD", names_to = "var") %>% 
  arrange(date_time) %>%
  group_by(var) %>% 
  mutate(MLD = na.approx(MLD)) %>%
  ungroup()

iCT_MLD <- iCT_MLD %>% 
  drop_na() %>% 
  group_by(var) %>% 
  arrange(date_time) %>% 
  mutate(CT_diff = CT - lag(CT),
         SST_diff = SST - lag(SST),
         CT_i_diff = CT_diff * MLD / 1000,
         CT_i_cum = cumsum(replace_na(CT_i_diff, 0))) %>% 
  ungroup()


```


### Incremental and cumulative timeseries

Total incremental and cumulative C~T~ changes inbetween cruise dates were calculated.


```{r plot_integrated_iCT_timeseries, fig.asp=1.5}

p_iCT <- iCT_MLD %>% 
  ggplot(aes(date_time, CT_i_diff, fill= var))+
  geom_hline(yintercept = 0)+
  geom_col(col="black", position = "dodge")+
  scale_y_continuous(breaks = seq(-100, 100, 0.2))+
  scale_fill_brewer(palette = "Set1", name="GETM variable")+
  labs(y="integrated CT changes [mol/m2]", x="date")

p_iCTcum <-  iCT_MLD %>% 
  ggplot(aes(date_time,  CT_i_cum, 
             col= var))+
  geom_hline(yintercept = 0)+
  geom_line()+
  scale_y_continuous(breaks = seq(-100, 100, 0.2))+
  scale_color_brewer(palette = "Set1", name="GETM variable")+
  labs(y="integrated, cumulative CT changes [mol/m2]")


p_iCT / p_iCTcum

rm(p_iCT, p_iCTcum)
```


## delta T appraoch

As primary production (negative changes in C~T~) and increase in seawater temperature have a common driver (light), the relation between both changes was investigated and will be used to reconstruct changes in CT throughout the water column.

The following analysis is restricted to the BloomSail period.

### SST time series

```{r FM_gt_2d_temp_timeseries}

fm_ts_ID %>% 
  filter(var == "tem") %>% 
  ggplot()+
  geom_rect(data = fixed_values, aes(xmin=start, xmax=end, ymin=-Inf, ymax=Inf), alpha=0.2)+
  geom_path(aes(x=date, y=value))+
  geom_point(aes(x=date, y=value, col="Finnmaid"))+
  geom_path(data = gt_2d, aes(x=date_time, y=SST, col="GETM, 3h"))+
  geom_path(data = gt_2d_daily, aes(x=date_time, y=SST, col="GETM, daily"))+
  scale_color_brewer(palette = "Set1", name="")+
  labs(x="", y="SST (°C)")

```

### dC~T~ vs dSST

To investigate the change of surface C~T~ with SST, we merge daily mean 2d GETM and Finnmaid data. GETM observations were linearly interpolated to match the time of Finnmaid observations.

```{r fm_gt_2d_merge}

CT_tem <- fm_ts_ID %>% 
  filter(var %in% c("tem", "CT")) %>% 
  select(date, var, value) %>% 
  pivot_wider(values_from = value, names_from = var) %>% 
  set_names(c("date_time", "FM", "CT"))

CT_tem <- full_join(CT_tem,
                    gt_2d_daily %>% select(date_time, gt = SST))


CT_tem <- CT_tem %>% 
  arrange(date_time) %>%
  mutate(gt = na.approx(gt)) %>% 
  drop_na() %>% 
  mutate(date = as.Date(date_time))

```

```{r CT_vs_temperature}

CT_tem <- CT_tem %>% 
  pivot_longer(cols = c(FM, gt), values_to = "SST", names_to = "obs")

CT_tem <- CT_tem %>% 
  group_by(obs) %>% 
  arrange(date_time) %>% 
  mutate(CT_diff = CT - lag(CT),
         SST_diff = SST - lag(SST),
         sign = if_else(CT_diff < 0, "neg", "pos")) %>% 
  ungroup()


lab_dates <- pretty(CT_tem$date_time)

CT_tem %>% 
  ggplot()+
  geom_hline(yintercept = 0)+
  geom_vline(xintercept = 0)+
  geom_smooth(aes(SST_diff, CT_diff), method = "lm", se=FALSE)+
  geom_point(aes(SST_diff, CT_diff, fill=as.numeric(date_time)), shape=21)+
  scale_fill_viridis_c(breaks = as.numeric(lab_dates),
                        labels = lab_dates,
                        name="Date")+
  guides(fill = guide_legend(override.aes=list(shape=21)))+
  facet_wrap(~obs)

```

The ratio of surface changes in CT with SST based on GETM SST was used.

```{r reconctruction_CT_incremental_changes_profiles}

CT_tem <- CT_tem %>% 
  filter(obs == "gt") %>% 
  mutate(factor = CT_diff/SST_diff,
         factor = if_else(is.na(factor), 0, factor)) 

# CT_tem %>% 
#   ggplot()+
#   geom_hline(yintercept = 0)+
#   geom_vline(xintercept = 0)+
#   geom_smooth(aes(SST_diff, CT_diff), method = "lm", se=FALSE)+
#   geom_point(aes(SST_diff, CT_diff, fill=factor), shape=21)+
#   scale_fill_viridis_c()

CT_tem <- expand_grid(CT_tem, dep = unique(gt_3d$dep))

fm_gt_3d <- full_join(gt_3d %>% select(date_time, dep, temp), 
                    CT_tem %>%  select(date_time, dep, factor))

fm_gt_3d <- fm_gt_3d %>% 
  arrange(date_time) %>% 
  group_by(dep) %>% 
  mutate(temp = na.approx(temp)) %>% 
  ungroup() %>% 
  drop_na()

fm_gt_3d <- fm_gt_3d %>% 
  group_by(dep) %>% 
  arrange(date_time) %>% 
  mutate(tem_diff = temp - lag(temp)) %>% 
  ungroup() %>% 
  mutate(CT_diff = tem_diff * factor) %>% 
  select(-factor)

# fm_gt_3d %>% 
#   ggplot(aes(tem_diff, CT_diff, col=date_time))+
#   geom_point()

```

The reconstructed incremental changes are added up to derive cummulative C~T~ changes throughout the water column.

```{r reconctruction_CT_cumulative_changes_profiles}

fm_gt_3d <- fm_gt_3d %>% 
  group_by(dep) %>% 
  arrange(date_time) %>% 
  mutate(time_diff  = as.numeric(date_time - lag(date_time)),
         CT_diff_daily = CT_diff / time_diff,
         CT_cum = cumsum(replace_na(CT_diff, 0))) %>% 
  ungroup()

```

### Profiles of incremental changes

Changes of seawater parameters at each depth were reconstructed from one cruise day to the next and divided by the number of days inbetween.

```{r incremental_changes_profiles}

fm_gt_3d %>% 
  arrange(dep) %>% 
  ggplot(aes(CT_diff_daily, dep, col=as.factor(date_time)))+
  geom_vline(xintercept = 0)+
  geom_point()+
  geom_path()+
  scale_y_reverse()+
  scale_color_viridis_d()+
  labs(x="Change of value inbetween cruises per day")


```

### Profiles of cumulative changes

Cumulative changes of seawater parameters were calculated at each depth relative to the first cruise day on July 5.

```{r cumulative_changes_profiles}

fm_gt_3d %>% 
  arrange(dep) %>% 
  ggplot(aes(CT_cum, dep, col=as.factor(date_time)))+
  geom_vline(xintercept = 0)+
  geom_point()+
  geom_path()+
  scale_y_reverse()+
  scale_color_viridis_d()+
  labs(x="Cumulative change of value")

```


### Hovmoeller daily changes

Hoevmoeller plots were generated for the reconstructed daily and cumulative changes in C~T~. Absolute values are not reproducible with this approach.


```{r plot_hovmoeller_daily, fig.cap="Hovmoeller plots of daily reconstructed changes in C~T~ and temperature. Note: Daily changes are currently plotted against the day when they were observed compared to the previous transect, although plotting against the mean date would be more plausible.", fig.asp=0.5, eval=FALSE}

bin_CT <- 20

fm_gt_3d %>%
  filter(dep < 26) %>% 
  ggplot()+
  geom_contour_fill(aes(x=date_time, y=dep, z=CT_diff_daily),
                    breaks = MakeBreaks(bin_CT),
                    col="black")+
  geom_point(aes(x=date_time, y=c(25)), size=3, shape=24, fill="white")+
  scale_fill_divergent(breaks = MakeBreaks(bin_CT),
                       guide = "colorstrip",
                       name="CT (µmol/kg)")+
  scale_y_reverse()+
  theme_bw()+
  labs(y="Depth (m)")+
  coord_cartesian(expand = 0)+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank())

rm(bin_CT)

```

### Hovmoeller cumulative changes

```{r plot_hovmoeller_cum, fig.cap="Hovmoeller plots of daily reconstructed changes in C~T~ and temperature.", fig.asp=0.5, eval=FALSE}

bin_CT <- 30

fm_gt_3d %>%
  filter(dep < 26) %>% 
  ggplot()+
  geom_contour_fill(aes(x=date_time, y=dep, z=CT_cum),
                    breaks = MakeBreaks(bin_CT),
                    col="black")+
  geom_point(aes(x=date_time, y=c(25)), size=3, shape=24, fill="white")+
  scale_fill_divergent(breaks = MakeBreaks(bin_CT),
                       guide = "colorstrip",
                       name="CT (µmol/kg)")+
  scale_y_reverse()+
  theme_bw()+
  labs(y="Depth (m)")+
  coord_cartesian(expand = 0)+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank())


rm(bin_CT)

```


## iC~T~ time series

Total incremental and cumulative C~T~ changes inbetween cruise dates were calculated for the upper 10 m of the water body.

```{r cumulative_directional_changes_profiles}

iCT_dT <- fm_gt_3d %>% 
  filter(dep < 10) %>% 
  group_by(date_time) %>%
  summarise(CT_i_diff = sum(CT_diff)/1000,
            CT_i_cum = sum(CT_cum)/1000) %>% 
  ungroup()


iCT_dT %>% 
  ggplot()+
  #geom_point(data = cruise_dates, aes(date_time_ID, 0), shape=21)+
  geom_col(aes(date_time, CT_i_diff),
           position = "dodge", alpha=0.3)+
  geom_line(aes(date_time, CT_i_cum))+
  scale_color_viridis_d(name="Depth limit (m)")+
  scale_fill_viridis_d(name="Depth limit (m)")+
  labs(y="iCT [mol/m2]", x="")+
  theme_bw()


```

# Open tasks / questions

- Re-read Finmmaid data in correct box including sd, min/max
- Plot timeseries with errorbars for fm and ts, use ts in 1 - 5 m
- Plot hovmoeller for GETM water mass age
- Move GETM windspeed to end
- Compare STD profiles and MLD: GETM vs BloomSail
- Plot profiles for:
  - GETM temperature at Finnmaid time stamps
  - GETM incremental temperature at Finnmaid time stamps
- Plot hovmoeller for incremental changes in GETM temperature
- Reference incremental changes to mean data and combine plots
- Why do we see strong iCT change in delta T appraoch on day 2? Plot delta T, SST and factor
- Can delta T approach be improved by:
  - Smoothened timeseries
  - Using a mean CT/SST factor
  - Using the cumulative values at iCT min


