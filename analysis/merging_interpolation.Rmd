---
title: "Merging and interpolation of observations"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```


```{r packages}
library(tidyverse)
library(lubridate)
library(zoo)
# library(dygraphs)
# library(xts)
```


# CTD and pCO~2~ data

## Merging summarized data sets


```{r load_summarized_data, eval=FALSE}
# Load Sensor and HydroC data ---------------------------------------------

CTD <- read_csv(here::here("Data/_summarized_data_files",
                              "Tina_V_Sensor_Profiles_Transects.csv"),
                   col_types = list("pCO2" = col_double())) %>% 
  rename(pCO2_analog = pCO2)

HC <- read_csv(here::here("Data/_summarized_data_files", "Tina_V_HydroC.csv"))
HC_full <- read_csv(here::here("Data/_summarized_data_files", "Tina_V_HydroC_full.csv"))

# Time offset correction ----------------------------------------------

# Time offset was determined by comparing zeroing reads from Sensor and HC
# in the plots produced in the section Time stamp synchronzity below
# before applying this correction

CTD <- CTD %>% 
  mutate(day = yday(date_time),
         date_time = if_else(day >= 206 & day <= 220,
                             date_time - 80, date_time - 10)) %>% 
  select(-day)

# Merge Sensor and HydroC data --------------------------------------------

df <- full_join(CTD, HC) %>% 
  arrange(date_time)

df_full <- full_join(CTD, HC_full) %>% 
  arrange(date_time)

rm(HC, HC_full, CTD)
```


## Interpolation to common time stamp

CTD and auxillary recordings (15 sec measurment interval) are interpolated to HydroC time stamps (first 10 sec, than 1 sec measurement interval) when gaps between observations are not larger than 20. Thereafter, HydroC readings not falling in regular transects/profilings are removed, by removing rows with NA depth values. Furthermore, CTD readings without corresponding HydroC reading are removed, except during periods when HydroC was not operating.

```{r interpolation, eval=FALSE}

# Interpolate Sensor data to HydroC timestamp

df <-
  df %>%
  mutate(dep = na.approx(dep, na.rm = FALSE, maxgap = 20),
         sal = na.approx(sal, na.rm = FALSE, maxgap = 20),
         tem = na.approx(tem, na.rm = FALSE, maxgap = 20),
         pCO2_analog = na.approx(pCO2_analog, na.rm = FALSE, maxgap = 20),
         pH = na.approx(pH, na.rm = FALSE, maxgap = 20),
         V_pH = na.approx(V_pH, na.rm = FALSE, maxgap = 20),
         O2 = na.approx(O2, na.rm = FALSE, maxgap = 20),
         Chl = na.approx(Chl, na.rm = FALSE, maxgap = 20)) %>% 
  filter(!is.na(dep)) %>% #remove HC readings not falling in regular transects/profilings
  fill(ID, type, station) %>% 
  filter(!is.na(deployment) | is.na(pCO2_analog)) # removes CTD readings without corresponding HydroC reading, except during periods when HydroC was not operating

df_full <-
  df_full %>%
  mutate(dep = na.approx(dep, na.rm = FALSE, maxgap = 20),
         sal = na.approx(sal, na.rm = FALSE, maxgap = 20),
         tem = na.approx(tem, na.rm = FALSE, maxgap = 20),
         pCO2_analog = na.approx(pCO2_analog, na.rm = FALSE, maxgap = 20),
         pH = na.approx(pH, na.rm = FALSE, maxgap = 20),
         V_pH = na.approx(V_pH, na.rm = FALSE, maxgap = 20),
         O2 = na.approx(O2, na.rm = FALSE, maxgap = 20),
         Chl = na.approx(Chl, na.rm = FALSE, maxgap = 20)) %>% 
  filter(!is.na(dep)) %>% #remove HC readings not falling in regular transects/profilings
  fill(ID, type, station) %>% 
  filter(!is.na(deployment) | is.na(pCO2_analog)) # removes CTD readings without corresponding HydroC reading, except during periods when HydroC was not operating

# Time stamp synchronzity -------------------------------------------------
# 
# df <- df %>% 
#   mutate(day = yday(date_time))
# 
# for (dayID in unique(df$day)) {
#   
#   df %>%
#     filter(day == dayID) %>% 
#       ggplot()+
#       geom_point(aes(date_time, pCO2, col="HC"))+
#       geom_point(aes(date_time, dep, col="dep"))+
#       geom_point(aes(date_time, pH, col="pH"))+
#       geom_point(aes(date_time, pCO2_analog, col="Sensor_int"))
#       
#     ggsave(here::here("/Plots/TinaV/Sensor/HydroC_diagnostics/Timing/day",
#                       paste(dayID,"_day_HydroC_merged.jpg", sep="")),
#            width = 10, height = 4)
# }
# 
# 
# for (depID in unique(df$deployment)) {
#   
#   df_dep <- df %>%
#     filter(deployment == depID, Zero == 1)
#   
#   for (zerID in unique(df_dep$Zero_ID)) {
#     
#     df_dep %>%
#       filter(Zero_ID == zerID) %>% 
#       ggplot()+
#       geom_point(aes(date_time, pCO2, col="HC"))+
#       geom_point(aes(date_time, pCO2_analog, col="Sensor_int"))
#     
#     ggsave(here::here("/Plots/TinaV/Sensor/HydroC_diagnostics/Timing/Zeroing",
#                       paste(depID,"_deployment_",zerID,"_Zero_ID_HydroC.jpg", sep="")),
#            width = 10, height = 4)
#     
#   }
# }

```


```{r safe_merged_data_file, eval=FALSE}

write_csv(df, here::here("Data/_merged_data_files", "BloomSail_CTD_HydroC.csv"))
write_csv(df_full, here::here("Data/_merged_data_files", "BloomSail_CTD_HydroC_full.csv"))

rm(df, df_full)

```


```{r timeseries_pCO2, fig.cap="pCO~2~ record after interpolation to HydroC timestamp (analog output from HydroC and drift corrected data provided by Contos). ID refers to the starting date of each cruise. Please note that pCO~2~ measurement range is restricted to 100-500  µatm here due to the settings of the analog voltage output of the sensor. Zeroing periods are included.", fig.asp = 3}

df <- read_csv(here::here("data/_merged_data_files",
                          "BloomSail_CTD_HydroC.csv"),
               col_types = cols(ID = col_character(),
                                pCO2_analog = col_double(),
                                pCO2 = col_double(),
                                Zero = col_factor(),
                                Flush = col_factor(),
                                Zero_ID = col_integer(),
                                deployment = col_integer(),
                                duration = col_double(),
                                mixing = col_character()))


df %>% 
  filter(!is.na(pCO2)) %>% 
  ggplot()+
  geom_path(aes(date_time, pCO2, col = "HydroC, drift corrected"))+
  geom_path(aes(date_time, pCO2_analog, col = "analog CTD"))+
  scale_color_brewer(palette = "Set1", name = "pCO2 record")+
  labs(y=expression(pCO[2]~(µatm)), x="")+
  facet_wrap(~ID, scales = "free_x", ncol = 1)

# ts <- xts(cbind(df$pCO2, df$dep), order.by = df$date_time)
# names(ts) <- c("pCO2", "Depth")
# 
# ts %>% 
#   dygraph() %>% 
#   dyRangeSelector() %>% #dateWindow = c("2012-01-01", "2016-12-31")
#   dySeries("pCO2", label = "pCO2") %>% 
#   dySeries("Depth", axis = 'y2', label = "Depth") %>% 
#   dyAxis("y", label = "pCO2 [µatm]") %>% 
#   dyAxis("y2", label = "Depth [m]") %>% 
#   dyOptions(drawPoints = TRUE, pointSize = 1)

```

```{r measurement_frequency, eval=FALSE, include=FALSE}

df <- df %>% 
  mutate(dt = c(0,diff(date_time)))

df %>% 
  filter(dt < 30) %>% 
  ggplot(aes(date_time, dt))+
  geom_point()

```

# Sensor and track data

```{r merge_sensor_track, eval=FALSE}

Sensor <- read_csv(here::here("data/_merged_data_files",
                          "BloomSail_CTD_HydroC.csv"),
               col_types = cols(ID = col_character(),
                                pCO2_analog = col_double(),
                                pCO2 = col_double(),
                                Zero = col_factor(),
                                Flush = col_factor(),
                                Zero_ID = col_integer(),
                                deployment = col_integer(),
                                duration = col_double(),
                                mixing = col_character()))


track <- 
  read_csv(here::here("Data/_summarized_data_files",
                       "TinaV_Track.csv"))


df <- full_join(Sensor, track) %>% 
  arrange(date_time)

# interpolate track data and than remove columns that originate from track time stamp
df <-
  df %>%
  mutate(lat = na.approx(lat, na.rm = FALSE, maxgap = 20),
         lon = na.approx(lon, na.rm = FALSE, maxgap = 20)) %>% 
  filter(!is.na(dep))

df %>% 
  write_csv(here::here("Data/_merged_data_files", "BloomSail_CTD_HydroC_track.csv"))

rm(df)
```


```


# Tasks / open questions

- Check interpolation to CTD Sensor timestamp as alternative option
