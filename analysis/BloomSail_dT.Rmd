---
title: "Reconstruction of NCP based on surface pCO2 and CTD data"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---


```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r packages}
library(tidyverse)
library(seacarb)
library(patchwork)
library(metR)
```

# Sensor data

1m gridded, downcast profiles were used. CO~2~-data at depths other than 3-4m were discarded to simulate a situation were only surface CO~2~ observations are available.

```{r read_Tina-V_Sensor_data}

df <-
  read_csv(here::here("Data/_merged_data_files", "BloomSail_CTD_HydroC_CT_cumulative_profiles.csv"))

df <- df %>% 
  select(1:5) %>% 
  pivot_wider(names_from = "parameter", values_from = "value") %>% 
  mutate(ID = as.factor(ID),
         CT = if_else(dep==3.5, CT, NaN))

```

# C~T~ vs temperature

As primary production (negative changes in C~T~) and increase in seawater temperature have a common driver (light), the relation between both changes was investigated.

```{r CT_and_temperature_changes_in_surface}

df_CT <- df %>%
  drop_na() %>% 
  arrange(date_time_ID) %>%
  mutate(dCT = CT - lag(CT, default = first(CT)))

df <- df %>%
  group_by(dep) %>% 
  arrange(date_time_ID) %>%
  mutate(dtem = tem - lag(tem, default = first(tem))) %>% 
  ungroup()

df <- full_join(df, df_CT)
rm(df_CT)

df %>% 
  filter(!is.na(dCT), dCT != 0) %>% 
  ggplot(aes(dtem, dCT))+
  geom_hline(yintercept = 0)+
  geom_vline(xintercept = 0)+
  geom_path()+
  geom_point(aes(fill=ID), shape=21)+
  scale_fill_viridis_d()


```

# Reconstruction of C~T~ dynamics

The ratio of the incremental change of C~T~ with temperature at the seasurface was applied to calculate the C~T~ in other water depth based on the known change in temperature.

```{r reconctruction_CT_incremental_changes_profiles}

df_factor <- df %>% 
  drop_na() %>% 
  mutate(factor = dCT/dtem,
         factor = if_else(is.na(factor), 0, factor)) %>% 
  select(ID, factor)

df <- full_join(df, df_factor)
rm(df_factor)

df <- df %>% 
  group_by(ID) %>%
  mutate(diff_value = dtem * factor) %>% 
  ungroup() %>% 
  select(-factor)

```

The reconstructed incremental changes are added up to derive cummulative C~T~ changes throughout the water column.

```{r reconctruction_CT_cumulative_changes_profiles}

df <- df %>% 
  group_by(dep) %>% 
  arrange(date_time_ID) %>% 
  mutate(diff_time  = as.numeric(date_time_ID - lag(date_time_ID)),
         diff_value_daily = diff_value / diff_time,
         cum_value = cumsum(diff_value))

```

## Profiles of incremental changes

Changes of seawater parameters at each depth were reconstructed from one cruise day to the next and divided by the number of days inbetween.

```{r incremental_changes_profiles}

df %>% 
  arrange(dep) %>% 
  ggplot(aes(diff_value_daily, dep, col=ID))+
  geom_vline(xintercept = 0)+
  geom_point()+
  geom_path()+
  scale_y_reverse()+
  scale_color_viridis_d()+
  #facet_wrap(~parameter, scales = "free_x")+
  labs(x="Change of value inbetween cruises per day")


```


## Profiles of cumulative changes

Cumulative changes of seawater parameters were calculated at each depth relative to the first cruise day on July 5.

```{r cumulative_changes_profiles}

df %>% 
  arrange(dep) %>% 
  ggplot(aes(cum_value, dep, col=ID))+
  geom_vline(xintercept = 0)+
  geom_point()+
  geom_path()+
  scale_y_reverse()+
  scale_color_viridis_d()+
  labs(x="Cumulative change of value")

```

Reconstructed cumulative positive and negative changes of seawater parameters were calculated separately at each depth relative to the first cruise day on July 5.

```{r cumulative_directional_changes_profiles}

df <- df %>% 
  mutate(sign = if_else(diff_value < 0, "neg", "pos")) %>% 
  group_by(dep, sign) %>%
  arrange(date_time_ID) %>%
  mutate(cum_value_sign = cumsum(diff_value)) %>% 
  ungroup()

df %>% 
  arrange(dep) %>% 
  ggplot(aes(cum_value_sign, dep, col=ID))+
  geom_vline(xintercept = 0)+
  geom_point()+
  geom_path()+
  scale_y_reverse()+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  facet_wrap(~sign, scales = "free_x", ncol=4)+
  labs(x="Cumulative directional change of value")

```


# Timeseries

## Incremental and cumulative

Total incremental and cumulative C~T~ changes inbetween cruise dates were calculated for 5m depth intervals.

```{r integrated_NCP}

NCP <- df %>% 
  mutate(dep = cut(dep, seq(0,30,5))) %>% 
  group_by(ID, date_time_ID, dep, sign) %>% 
  summarise(dCT = sum(diff_value)/1000) %>% 
  ungroup()

NCP <- NCP %>% 
  group_by(sign, dep) %>% 
  arrange(date_time_ID) %>%
  mutate(dCT_cum = cumsum(dCT)) %>% 
  ungroup()

NCP_grid <- expand_grid(
  unique(NCP$date_time_ID),
  unique(NCP$dep),
  unique(NCP$sign)
)

NCP_grid <- NCP_grid %>% 
  set_names(c("date_time_ID","dep", "sign"))

NCP <- full_join(NCP, NCP_grid)

rm(NCP_grid)

NCP <- NCP %>% 
  arrange(sign, dep, date_time_ID) %>% 
  group_by(sign, dep) %>% 
  fill(dCT_cum) %>% 
  ungroup() %>% 
  mutate(dCT_cum = if_else(is.na(dCT_cum), 0, dCT_cum))

```

```{r plot_integrated_NCP_timeseries, fig.asp=1.5}

p_iNCP <- NCP %>% 
  ggplot(aes(date_time_ID, dCT, fill=dep))+
  geom_hline(yintercept = 0)+
  geom_bar(stat="identity", col="black")+
  scale_fill_viridis_d()+
  scale_y_continuous(breaks = seq(-100, 100, 0.2))+
  facet_grid(rev(sign)~., scales = "free_y", space = "free_y")+
  theme(strip.background = element_blank(),
        strip.text = element_blank())+
  labs(y="integrated, directional CT changes [mol/m2]", x="date")

p_iNCPcum <- NCP %>% 
  ggplot(aes(date_time_ID,  dCT_cum, fill=dep))+
  geom_hline(yintercept = 0)+
  geom_area(col="black")+
  scale_fill_viridis_d()+
  scale_y_continuous(breaks = seq(-100, 100, 0.2))+
  facet_grid(rev(sign)~., scales = "free_y", space = "free_y")+
  theme(strip.background = element_blank(),
        strip.text = element_blank())+
  labs(y="integrated, cumulative, directional CT changes [mol/m2]", x="date")


(p_iNCP / p_iNCPcum)+
  plot_layout(guides = 'collect')

rm(p_iNCP, p_iNCPcum)
```


# Hovmoeller plots

## Daily changes

```{r plot_hovmoeller_daily, fig.cap="Hovmoeller plots of daily changes in C~T~ and temperature. Note: Daily changes are currently plotted against the day when they were observed compared to the previous transect, although plotting against the mean date would be more plausible.", fig.asp=0.5}

bin_CT <- 2.5

df %>% 
  ggplot()+
  geom_contour_fill(aes(x=date_time_ID, y=dep, z=diff_value_daily),
                    breaks = MakeBreaks(bin_CT),
                    col="black")+
  geom_point(aes(x=date_time_ID, y=c(24.5)), size=3, shape=24, fill="white")+
  scale_fill_divergent(breaks = MakeBreaks(bin_CT),
                       guide = "colorstrip",
                       name="CT (µmol/kg)")+
  scale_y_reverse()+
  theme_bw()+
  labs(y="Depth (m)")+
  coord_cartesian(expand = 0)+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank())



```


