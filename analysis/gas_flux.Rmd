---
title: "Gas exchange"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---


```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r packages}
library(tidyverse)
#library(patchwork)
library(seacarb)
library(zoo)
#library(metR)
#library(scico)
# library(broom)
library(lubridate)
# library(tibbletime)
library(marelac)
library(seacarb)
```


# Sensor data

The cruise mean pCO~2~ recorded in profiling-mode (stations only) and depths < 3m was used for gas exchange calcualtions.

```{r read_Tina-V_Sensor_data}

water <-
  read_csv(here::here("Data/_merged_data_files", "BloomSail_CTD_HydroC_CT.csv"))

water <- water %>% 
  filter(dep < 3) %>% 
  select(date_time, ID, tem, pCO2_water = pCO2)

water_ID <- water %>% 
  group_by(ID) %>% 
  summarise_all(mean) %>% 
  ungroup() %>% 
  select(-ID)

water_ID %>% 
  ggplot(aes(date_time, pCO2_water))+
  geom_point(data=water, aes(date_time, pCO2_water), col="grey")+
  geom_path()+
  geom_point()

start <- min(water$date_time)
end   <- max(water$date_time)

```


# Wind data

Metrological data were recorded on the flux tower located on Ostergarnsholm island.

```{r read_wind_Ostergarn_tower}

air <- read_delim(here::here("Data/Ostergarnsholm/Tower", "Oes_Jens_atm_water_June_to_August_2018.csv"),
                 delim = ";"               )

air <- air %>%
  mutate(date_time = ymd_hms( paste(paste(year, month, day, sep = "/"),
                                          paste(hour, min, sec, sep = ":")))) %>% 
  select("date_time",
         "CO2 12m [ppm]",
         "w_c [ppm m/s]",
         "WS 12m [m/s]",
         "WD 12m [degrees]",
         "T 12m [degrees C]",
         "RIS [W/m^2]"
         ) %>% 
  filter(date_time > start,
         date_time < end)

rm(end, start)

air <- air %>% 
  mutate(freq = "30 min") %>% 
  select(date_time, freq, pCO2_air = "CO2 12m [ppm]", wind = "WS 12m [m/s]")



```


```{r join_interpolate_wind_water_data}

df <- full_join(air, water_ID) %>% 
  arrange(date_time)

df <- df %>% 
  mutate(pCO2_water = na.approx(pCO2_water, rule = 2),
         tem = na.approx(tem, rule = 2),
         wind = na.approx(wind, rule = 2)) %>% 
  filter(!is.na(pCO2_air))

df_daily <- df %>% 
  mutate(day = yday(date_time)) %>% 
  group_by(day) %>% 
  summarise_all(mean, na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-day) %>% 
  mutate(freq = "daily")

df <- bind_rows(df, df_daily)


rm(air, water_ID, water, df_daily)


```

## Time series plot

```{r plot_wind_Ostergarn_tower}

df_long <- df %>% 
  gather("parameter", "value", 3:6)

df_long %>% 
  ggplot(aes(date_time, value, col=freq))+
  geom_line()+
  facet_grid(parameter~., scales = "free_y")+
  scale_color_brewer(palette = "Set1", direction = -1)+
  theme_bw()

```

# Air-sea CO~2~ flux

## Calculation

F = k * dCO2

with

dCO2 = K0 * dpCO2 and 

k = coeff * U^2 * (660/Sc)^0.5


Units used here are:

- dpCO~2~: µatm
- K0: mol atm-1 kg-1
- dCO~2~: µmol kg-1

- wind speed U: m s-1

- coeff for k calculation (eg 0.251 in W14): cm hr-1 (m s-1)-2 
- gas transfer velocities k: cm hr-1 (= 60*60*100 m s-1)

- air sea CO~2~ flux F: mol m–2 d–1

- conversion between the unit of k * dCO2 and F requires a factor of 10-5 * 24

```{r gas_exchange_calc}

Sc_W14 <- function(tem) {
  2116.8 - 136.25 * tem + 4.7353 * tem^2 - 0.092307 * tem^3 + 0.0007555 * tem^4
}

Sc_W14(20)

df <- df %>% 
  mutate(dpCO2 = pCO2_water - pCO2_air,
         dCO2  = dpCO2 * K0(S=6.92, T=tem),
         k_W92 = gas_transfer(t = tem, u10 = wind, species = "CO2", method = "Wanninkhof1")* 60^2 * 100,
         k_W14 = 0.251 * wind^2 * (Sc_W14(tem)/660)^(-0.5),
         #F_W14_simple = 7.7 * 10^(–4) wind^2,
         k_SM18 = 0.24 * wind^2 * ((1943-119.6*tem + 3.488*tem^2 - 0.0417*tem^3) / 660)^(-0.5)) %>% 
  pivot_longer(9:11, names_to = "k_para", values_to = "k_value")

# calculate flux F [mol m–2 d–1]

df <- df %>% 
  mutate(flux_daily = k_value*dCO2*1e-5*24) 




```

Timeseries 

```{r plot_daily_fluxes}

df %>% 
  ggplot(aes(date_time, flux_daily, col=k_para))+
  geom_line()+
  labs(y="F (mol m-2 d-1)")+
  facet_wrap(~freq)

# scale flux to time interval

df <- df %>% 
  mutate(scale = if_else(freq == "daily", 1, 24*2)) %>% 
  mutate(flux_scale = flux_daily / scale) %>% 
  group_by(freq, k_para) %>% 
  arrange(date_time) %>% 
  mutate(flux_cum = cumsum(flux_scale)) %>% 
  ungroup()

df %>% 
  ggplot(aes(date_time, flux_cum, col=k_para))+
  geom_line()+
  labs(y="F (mol m-2)")+
  facet_wrap(~freq)
```


# Open tasks / questions

- Calculate mean wind direction correctly for northerly winds
- Correct conversion of CO2 concentration from mol kg-1 to mol m-3 required?
