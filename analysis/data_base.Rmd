---
title: "Data base"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```


```{r packages}
library(tidyverse)
library(data.table)
library(lubridate)
library(DataExplorer)
```

# CTD Sensor data

## Regular profiles and transects

CTD Sensor data including recordings from auxiliary pH, O~2~, Chla and pCO~2~ sensors were recorded with a measurement frequency of 15 sec. Furthermore, pCO~2~ data were also internally recorded on the Contros HydroC instrument with higher temporal resolution and will be used for further analysis.

```{r read_profile_transect_CTD_data}

setwd("C:/Mueller_Jens_Data/Research/Projects/BloomSail/data/TinaV/Sensor/Profiles_Transects")
files <- list.files(pattern = "[.]cnv$")
#file <- files[1]

for (file in files){
  
  start.date <- data.table(read.delim(file, sep="#", nrows = 160))[[78,1]]
  start.date <- substr(start.date, 15, 34)
  start.date <- mdy_hms(start.date, tz="UTC")
  
  tempo <- read.delim(file, sep="", skip = 160, header = FALSE)
  tempo <- data.table(tempo[,c(2,3,4,5,6,7,9,11,13)])
  names(tempo) <- c("date", "Dep.S", "Tem.S", "Sal.S", "V_pH", "pH", "Chl", "O2", "pCO2")
  tempo$start.date <- start.date
  tempo$date <- tempo$date + tempo$start.date
  
  tempo$transect.ID <- substr(file, 1, 6)
  tempo$type <- substr(file, 8,8)
  tempo$label <- substr(file, 8,10)
  
  tempo$cast <- "up"
  tempo[date < mean(tempo[Dep.S == max(tempo$Dep.S)]$date)]$cast <- "down"
  
  if (exists("dataset")){
    dataset <- rbind(dataset, tempo)
  }
  
  if (!exists("dataset")){
    dataset <- tempo
  }
  
  rm(start.date)
  rm(tempo)
}


CTD <- dataset
rm(dataset, file, files)


setwd("C:/Mueller_Jens_Data/Research/Projects/BloomSail/")

```

CTD recordings were cleaned from obviously erroneous readings, by setting values to NA. 

```{r clean_CTD_data}

#### plots generated to check succesful read-in and data-quality ####
#### removal of errornous recordings ####

#### Profiling data

# Temperature

# CTD %>% 
#   filter(type == "P") %>% 
#   ggplot(aes(Tem.S, Dep.S, col=label, linetype = cast))+
#   geom_line()+
#   scale_y_reverse()+
#   geom_vline(xintercept = c(10, 20))+
#   facet_wrap(~transect.ID)

CTD[transect.ID == "180723" & label == "P07" & Dep.S < 2 & cast == "up"]$Tem.S <- NA

# Salinity

# CTD %>% 
#   filter(type == "P") %>% 
#   ggplot(aes(Sal.S, Dep.S, col=label, linetype = cast))+
#   geom_path()+
#   scale_y_reverse()+
#   facet_wrap(~transect.ID)

CTD[Sal.S < 6]$Sal.S <- NA

# pH

# CTD %>% 
#   filter(type == "P") %>% 
#   ggplot(aes(pH, Dep.S, col=label, linetype=cast))+
#   geom_path()+
#   scale_y_reverse()+
#   facet_wrap(~transect.ID)
# 
# CTD %>% 
#   filter(type == "P") %>% 
#   ggplot(aes(V_pH, Dep.S, col=label, linetype=cast))+
#   geom_path()+
#   scale_y_reverse()+
#   facet_wrap(~transect.ID)

CTD[pH < 7.5]$V_pH <- NA
CTD[pH < 7.5]$pH <- NA

CTD[transect.ID == "180709" & label == "P03" & Dep.S < 5 & cast == "down"]$pH <- NA
CTD[transect.ID == "180709" & label == "P05" & Dep.S < 10 & cast == "down"]$pH <- NA
CTD[transect.ID == "180718" & label == "P10" & Dep.S < 3 & cast == "down"]$pH <- NA
CTD[transect.ID == "180815" & label == "P03" & Dep.S < 2 & cast == "down"]$pH <- NA
CTD[transect.ID == "180820" & label == "P11" & Dep.S < 15 & cast == "down"]$pH <- NA

CTD[transect.ID == "180709" & label == "P03" & Dep.S < 5 & cast == "down"]$V_pH <- NA
CTD[transect.ID == "180709" & label == "P05" & Dep.S < 10 & cast == "down"]$V_pH <- NA
CTD[transect.ID == "180718" & label == "P10" & Dep.S < 3 & cast == "down"]$V_pH <- NA
CTD[transect.ID == "180815" & label == "P03" & Dep.S < 2 & cast == "down"]$V_pH <- NA
CTD[transect.ID == "180820" & label == "P11" & Dep.S < 15 & cast == "down"]$V_pH <- NA


# pCO2

# CTD %>% 
#   filter(type == "P") %>% 
#   ggplot(aes(pCO2, Dep.S, col=label, linetype = cast))+
#   geom_path()+
#   scale_y_reverse()+
#   facet_wrap(~transect.ID)

CTD[transect.ID == "180616"]$pCO2 <- NA

# O2

# CTD %>% 
#   filter(type == "P") %>% 
#   ggplot(aes(O2, Dep.S, col=label, linetype = cast))+
#   geom_path()+
#   scale_y_reverse()+
#   facet_wrap(~transect.ID)

# Chlorophyll

# CTD %>% 
#   filter(type == "P") %>% 
#   ggplot(aes(Chl, Dep.S, col=label, linetype = cast))+
#   geom_path()+
#   scale_y_reverse()+
#   facet_wrap(~transect.ID)

CTD[Chl > 100]$Chl <- NA


#### Surface transect data

# CTD %>% 
#   filter(type == "T") %>% 
#   ggplot(aes(date, Dep.S, col=label))+
#   geom_point()+
#   scale_y_reverse()+
#   facet_wrap(~transect.ID, scales = "free_x")
# 
# CTD %>% 
#   filter(type == "T") %>% 
#   ggplot(aes(date, Tem.S, col=label))+
#   geom_point()+
#   facet_wrap(~transect.ID, scales = "free_x")
# 
# CTD %>% 
#   filter(type == "T") %>% 
#   ggplot(aes(date, Sal.S, col=label))+
#   geom_point()+
#   facet_wrap(~transect.ID, scales = "free_x")
# 
# CTD %>% 
#   filter(type == "T") %>% 
#   ggplot(aes(date, pCO2, col=label))+
#   geom_point()+
#   facet_wrap(~transect.ID, scales = "free_x")
# 
# CTD %>% 
#   filter(type == "T") %>% 
#   ggplot(aes(date, pH, col=label))+
#   geom_point()+
#   facet_wrap(~transect.ID, scales = "free_x")
# 
# CTD %>% 
#   filter(type == "T") %>% 
#   ggplot(aes(date, Chl, col=label))+
#   geom_point()+
#   facet_wrap(~transect.ID, scales = "free_x")

CTD[type == "T" & Chl > 10]$Chl <- NA


# CTD %>% 
#   filter(type == "T") %>% 
#   ggplot(aes(date, O2, col=label))+
#   geom_point()+
#   facet_wrap(~transect.ID, scales = "free_x")

```

Relevant columns were selected and renamed, only observations from regular stations (P01-P13) and transects (T01-T13) were selected and summarized data were written to file.

```{r subsetting_writing_summary_file}

CTD <-
  CTD %>% 
  select(date_time=date,
         ID=transect.ID,
         type,
         station=label,
         cast,
         dep=Dep.S,
         sal=Sal.S,
         tem=Tem.S,
         pCO2,pH,V_pH,O2,Chl)

CTD <- CTD %>% 
  filter( !(station %in% c("PX1", "PX2", "TX1", "TX2") ))

CTD %>% 
  write_csv(here::here("data/_summarized_data_files", "Tina_V_Sensor_Profiles_Transects.csv"))
```

```{r CTD_EDA, eval=FALSE, include=FALSE}

CTD %>% 
  create_report(output_dir = "docs/", output_file = "EDA_report_CTD.html")

```


The output of an automated Exploratory Data Analysis (EDA) performed with the package `DataExplorer` can be accessed [here](https://jens-daniel-mueller.github.io/BloomSail/EDA_report_CTD.html){target="_blank}


```{r Overview_temperature_profiles, fig.cap="Temperature profiles recorded on regular stations P01-P13. ID refers to the starting date of each cruise.", fig.asp = 1.3}

CTD %>%
  arrange(date_time) %>% 
  filter(type == "P") %>%
  ggplot(aes(tem, dep, col=station, linetype = cast))+
  geom_path()+
  scale_y_reverse()+
  labs(x="Temperature (°C)", y="Depth (m)")+
  facet_wrap(~ID, labeller = label_both)

```

```{r Overview_pCO2_analog_profiles, fig.cap="pCO~2~ profiles (analog output from HydroC) recorded on regular stations P01-P13. ID refers to the starting date of each cruise. Please note that pCO~2~ measurement range is restricted to 100-500  µatm here due to the settings of the analog voltage output of the sensor. Zeroing periods are included.", fig.asp = 1.3}

CTD %>%
  arrange(date_time) %>% 
  filter(type == "P") %>%
  ggplot(aes(pCO2, dep, col=station, linetype = cast))+
  geom_path()+
  scale_y_reverse()+
  labs(x=expression(pCO[2]~(µatm)), y="Depth (m)")+
  facet_wrap(~ID, labeller = label_both)

```


# pCO~2~ data

HydroC pCO~2~ data  were provided by KM Contros after applying a drift correction to the raw data, which was based on pre- and post-deployment calibration results. 

```{r read_HydroC_raw_data}

# Read Contros corrected data file

HC <-
  read_csv2(here::here("Data/TinaV/Sensor/HydroC-pCO2/corrected_Contros",
                       "parameter&pCO2s(method 43).txt"),
            col_names = c("date_time", "Zero", "Flush", "p_NDIR",
                          "p_in", "T_control", "T_gas", "%rH_gas",
                          "Signal_raw", "Signal_ref", "T_sensor",
                          "pCO2", "Runtime", "nr.ave")) %>% 
  mutate(Flush = as.factor(as.character(Flush)),
         Zero = as.factor(as.character(Zero))) %>% 
  select(date_time, Zero, Flush, pCO2)

```

Individual deployments (periods of observations with less than 30 sec between recordings) were identified and relevant deployment periods were subsetted.

```{r HydroC_deployment}

# Deployments: Identification

HC <- HC %>% 
  mutate(date_time = dmy_hms(date_time),
         deployment = cumsum(c(TRUE,diff(date_time)>=30)))


# Deployments: Plots

# for (i in unique(HC$deployment)) {
# 
#   HC %>%
#     filter(deployment == i) %>%
#     ggplot(aes(date_time, pCO2_corr, col=as.factor(Zero)))+
#     geom_line()
# 
#   ggsave(here::here("/Plots/TinaV/Sensor/HydroC_diagnostics/Deployments",
#                     paste(i,"_deployment_HydroC_timeseries.jpg", sep="")),
#          width = 15, height = 4)
# 
# }
# 
# HC %>%
#   ggplot(aes(date_time, pCO2_corr, col=as.factor(deployment)))+
#   geom_line()
# 
# ggsave(here::here("/Plots/TinaV/Sensor/HydroC_diagnostics/Deployments",
#                   "all_deployment_HydroC_timeseries.jpg"),
#        width = 40, height = 4)




# Deployments: Subset relevant periods ------------------------------------

# Subset deployment 29 for high resolution response time determination

# HC %>%
#   filter(deployment == 29) %>%
#   write_csv(here::here("Data/_summarized_data_files",
#                        "Tina_V_Sensor_HydroC_RT-experiment_29.csv"))

HC <- HC %>% 
  filter(deployment %in% c(2,6,9,14,17,21,23,27,29,31,33,34,35,37))
         
```

Individual zeroings were labeled with a counter and a period of 10 min after the zeroing was labelled as Flush period (overriding the internal Flush flag). A mixing flag was introduced, flagging the initial 20 sec of each Flush period as "mixing" and the rest as "equilibration".

```{r HC_zeroing}

# Zeroing ID labelling

HC <- HC %>% 
  group_by(Zero) %>% 
  mutate(Zero_ID = as.factor(cumsum(c(TRUE,diff(date_time)>=30)))) %>% 
  ungroup()


# Flush: Identification

HC <- HC %>% 
  mutate(Flush = 0) %>% 
  group_by(Zero, Zero_ID) %>% 
  mutate(start = min(date_time),
         duration = date_time - start,
         Flush = if_else(Zero == 0 & duration < 600, "1", "0")) %>% 
  ungroup()


#  Flush: Identify equilibration and internal gas mixing periods

HC <- HC %>% 
  mutate(mixing = if_else(duration < 20, "mixing", "equilibration"))

# Flush <- HC %>% 
#   filter(Flush == 1, duration <=300)


# Flush: Plot individual periods

# for (i in unique(Flush$Zero_ID)) {
# 
#   Flush %>%
#     filter(Zero_ID == i) %>%
#     ggplot(aes(duration, pCO2, col=mixing))+
#     geom_point() +
#     scale_color_brewer(palette = "Set1")
# 
#   ggsave(here::here("/Plots/TinaV/Sensor/HydroC_diagnostics/Flush",
#                     paste(i,"_Zero_ID_HydroC_Flush.jpg", sep="")),
#          width = 10, height = 4)
# 
# }
# 
# for (i in unique(HC$Zero_ID)) {
# 
#   HC %>%
#     filter(Flush == 1, Zero_ID == i) %>%
#     ggplot(aes(duration, pCO2, col=mixing))+
#     geom_point() +
#     scale_color_brewer(palette = "Set1")
# 
#   ggsave(here::here("/Plots/TinaV/Sensor/HydroC_diagnostics/Flush",
#                     paste(i,"_Zero_ID_HydroC_HC.jpg", sep="")),
#          width = 10, height = 4)
# 
# }


# Clean data: Plot deployments

# for (i in unique(HC$deployment)) {
# 
#   HC %>%
#     filter(Zero ==0, Flush == 0, deployment == i) %>%
#     ggplot(aes(date_time, pCO2_corr, col=Zero_ID))+
#     geom_line()
# 
#   ggsave(here::here("/Plots/TinaV/Sensor/HydroC_diagnostics/Deployments_clean", paste(i,"_deployment_only_HydroC_timeseries.jpg", sep="")),
#          width = 15, height = 4)
# 
# }


```

Summarized pCO~2~ date were written to file.

```{r writing_summary_file}

# Write summarized data files

HC %>% 
  write_csv(here::here("Data/_summarized_data_files",
                       "Tina_V_HydroC.csv"))

# Flush %>%
#   write_csv(here::here("Data/_summarized_data_files",
#                        "Tina_V_HydroC_Flush.csv"))

```



# Tasks / open questions

- include standardized data quality checks after each step of read-in and merging 

- Include data around Ostergarnsholm island and crossing large vessels 

- Include information about HydroC calibration results and raw data correction by Contros

- Check results from field response time experiment (high zeroing frequency)
